# CAN FD 控制器特性列表

## 文档信息

| 项目 | 内容 |
|------|------|
| 模块名称 | CAN FD Controller |
| 版本 | V1.0 |
| 创建日期 | 2026-01-19 |
| 目标 ASIL | ASIL-B |

---

## 1. 总体特性

### 1.1 协议支持

| 特性 | 描述 | 优先级 |
|------|------|--------|
| CAN 2.0 A/B | 经典 CAN 协议 | 必须 |
| CAN FD | ISO 11898-2 (64-byte 数据) | 必须 |
| CAN FD ISO | ISO 标准模式 | 必须 |
| CAN XL | 可选扩展 (2048-byte) | 可选 |
| ISO 11898-1 | 物理层与数据链路层 | 必须 |

### 1.2 通道配置

| 特性 | 描述 | 取值 |
|------|------|------|
| CAN 通道数 | 可配置的 CAN 端口 | 1-8 |
| 默认通道数 | 初始配置 | 4 |
| 独立时钟 | 每个通道独立时钟域 | 可选 |

### 1.3 数据速率

| 特性 | 描述 | 取值 |
|------|------|------|
| 仲裁位速率 | 标称位速率 | 100K-1Mbps |
| 数据位速率 | 数据阶段位速率 | 500K-5Mbps |
| 采样点 | 位时间采样位置 | 50%-87.5% |
| 再同步跳转宽度 | SJW 配置 | 1-4 TQ |

---

## 2. 功能特性

### 2.1 发送功能

| 特性 | 描述 | 优先级 |
|------|------|--------|
| 发送缓冲区 | TX FIFO 深度 | 32 |
| 发送队列 | 优先级排序 | 必须 |
| 发送请求 | 手动/自动触发 | 必须 |
| 发送取消 | 中止发送 | 必须 |
| 单次发送 | 单帧发送模式 | 可选 |
| 发送优先级 | 基于消息 ID 优先级 | 必须 |
| 远程帧 | 支持远程帧请求 | 必须 |
| 位填充 | CAN 协议位填充 | 必须 |
| STI 模式 | 单次发送与重试 | 可选 |

### 2.2 接收功能

| 特性 | 描述 | 优先级 |
|------|------|--------|
| 接收缓冲区 | RX FIFO 深度 | 64 |
| 接收滤波器 | 基于 ID 过滤 | 必须 |
| 滤波器数量 | 验收滤波器数量 | 32 |
| 掩码配置 | 扩展掩码支持 | 必须 |
| 远程帧过滤 | 拒绝/接受远程帧 | 必须 |
| 接收溢出 | 溢出检测与通知 | 必须 |
| 接收时间戳 | Rx 帧时间戳 | 可选 |
| 环形缓冲 | 替代 FIFO 模式 | 可选 |

### 2.3 错误处理

| 特性 | 描述 | 优先级 |
|------|------|--------|
| 错误计数 | TX/RX 错误计数器 | 必须 |
| 错误状态 | 主动/被动/离线状态 | 必须 |
| 错误警告 | 阈值警告中断 | 必须 |
| 错误捕获 | 错误类型捕获 | 必须 |
| 总线关闭 | Bus-off 自动恢复 | 必须 |
| 主动错误 | 主动错误帧 | 必须 |
| 被动错误 | 被动错误帧 | 必须 |
| CRC 校验 | 15-bit CRC (CAN FD 17/21-bit) | 必须 |
| 格式错误 | 位填充错误检测 | 必须 |
| 位错误 | 发送位错误检测 | 必须 |
| ACK 错误 | ACK 错误检测 | 必须 |
| 错误记录 | 错误日志寄存器 | 可选 |

### 2.4 位时序

| 特性 | 描述 | 优先级 |
|------|------|--------|
| 可编程位时序 | 任意位速率配置 | 必须 |
| 同步段 | 固定 1 TQ | 必须 |
| 传播段 | 1-8 TQ | 必须 |
| 相位缓冲段 | 1-8 TQ | 必须 |
| 重新同步 | 边沿重新同步 | 必须 |
| 三次采样 | 多数决采样 | 可选 |
| 关闭模式 | 总线关闭状态 | 必须 |

---

## 3. 消息对象

### 3.1 标准标识符

| 特性 | 描述 | 取值 |
|------|------|------|
| ID 宽度 | 标准 ID 位宽 | 11-bit |
| 扩展 ID | 扩展标识符支持 | 可选 |
| IDE 位 | ID 扩展指示 | 必须 |

### 3.2 扩展标识符

| 特性 | 描述 | 取值 |
|------|------|------|
| ID 宽度 | 扩展 ID 位宽 | 29-bit (如果支持) |
| FDF 位 | FD 格式指示 | 必须 |

### 3.3 数据长度

| 特性 | 描述 | 取值 |
|------|------|------|
| 经典 CAN | 数据长度 | 0-8 bytes |
| CAN FD | 数据长度 | 0-64 bytes |
| DLC 编码 | 4-bit DLC | 必须 |

---

## 4. 中断功能

### 4.1 中断源

| 中断源 | 描述 | 类型 |
|--------|------|------|
| TX 完成 | 发送完成中断 | 脉冲 |
| RX 完成 | 接收完成中断 | 脉冲 |
| TX 缓冲空 | 发送缓冲区空 | 电平 |
| RX 缓冲满 | 接收缓冲区满 | 电平 |
| 错误警告 | 错误计数警告 | 电平 |
| 错误被动 | 进入被动状态 | 脉冲 |
| 总线离线 | Bus-off 状态 | 脉冲 |
| 唤醒中断 | 唤醒事件 | 脉冲 |
| 仲裁丢失 | 仲裁丢失中断 | 可选 |
| 超载帧 | 超载帧产生 | 可选 |

### 4.2 中断聚合

| 特性 | 描述 | 取值 |
|------|------|------|
| 全局中断 | 聚合所有中断 | 必须 |
| 通道中断 | 独立通道中断 | 必须 |
| 中断使能 | 全局/局部使能 | 必须 |
| 中断优先级 | 中断优先级配置 | 可选 |

---

## 5. DMA 功能

| 特性 | 描述 | 优先级 |
|------|------|--------|
| TX DMA | 发送 DMA 请求 | 必须 |
| RX DMA | 接收 DMA 请求 | 必须 |
| DMA 突发 | 突发传输支持 | 可选 |
| DMA 优先级 | DMA 优先级配置 | 可选 |

---

## 6. 低功耗功能

| 特性 | 描述 | 优先级 |
|------|------|--------|
| 休眠模式 | 低功耗休眠 | 必须 |
| 唤醒源 | CAN 唤醒 | 必须 |
| 停止模式 | 停止模式支持 | 可选 |
| 时钟门控 | 动态时钟门控 | 必须 |

---

## 7. 功能安全特性 (ASIL-B)

### 7.1 硬件安全机制

| 特性 | 描述 | ASIL |
|------|------|------|
| 双核锁步 | 冗余比较器 | ASIL-D |
| CRC 校验 | 数据完整性 | ASIL-B |
| 看门狗 | 超时检测 | ASIL-B |
| 错误注入 | 测试安全机制 | ASIL-B |
| 状态监控 | 状态寄存器监控 | ASIL-B |

### 7.2 冗余设计

| 特性 | 描述 | 覆盖率 |
|------|------|--------|
| 发送路径冗余 | 双发送路径 | 90% |
| 接收路径冗余 | 双接收路径 | 90% |
| 寄存器冗余 | 关键寄存器奇偶校验 | 100% |

### 7.3 故障模式

| 故障模式 | 检测机制 | 响应 |
|----------|----------|------|
| 寄存器翻转 | ECC/奇偶校验 | 中断+复位 |
| 计数器卡死 | 变化监控 | 中断 |
| 总线卡死 | 看门狗 | 复位 |
| 协议违例 | 协议检查 | 错误帧 |

---

## 8. 配置寄存器

### 8.1 控制寄存器

| 寄存器 | 偏移 | 描述 |
|--------|------|------|
| CTRL | 0x000 | 控制寄存器 |
| STAT | 0x004 | 状态寄存器 |
| ERR | 0x008 | 错误计数器 |
| BTR | 0x00C | 位时序配置 |
| INT_EN | 0x010 | 中断使能 |
| INT_STAT | 0x014 | 中断状态 |

### 8.2 发送寄存器

| 寄存器 | 偏移 | 描述 |
|--------|------|------|
| TX_CTRL | 0x020 | 发送控制 |
| TX_ID | 0x024 | 发送 ID |
| TX_DATA | 0x028-0x044 | 发送数据 |
| TX_REQ | 0x048 | 发送请求 |

### 8.3 接收寄存器

| 寄存器 | 偏移 | 描述 |
|--------|------|------|
| RX_ID | 0x060 | 接收 ID |
| RX_DATA | 0x064-0x080 | 接收数据 |
| RX_ACK | 0x084 | 接收确认 |
| RX_COUNT | 0x088 | 接收计数 |

### 8.4 滤波器寄存器

| 寄存器 | 偏移 | 描述 |
|--------|------|------|
| AFC_CTRL | 0x0A0 | 滤波器控制 |
| AF_ID | 0x0A4-0x0FC | 滤波器 ID |
| AF_MASK | 0x100-0x17C | 滤波器掩码 |

---

## 9. 性能指标

### 9.1 时序要求

| 参数 | 描述 | 目标 |
|------|------|------|
| Setup Time | 输入建立时间 | 5ns |
| Hold Time | 输入保持时间 | 2ns |
| Clock to Out | 输出时钟到有效 | 8ns |
| Max Frequency | 最高工作频率 | 200MHz |

### 9.2 面积估算

| 模块 | 门数 | 备注 |
|------|------|------|
| CAN Top | 15K | 含所有通道 |
| 每通道 | 3K | 独立通道逻辑 |
| 位时序 | 2K | TDC + BTT |
| 错误处理 | 1K | 错误状态机 |

### 9.3 功耗估算

| 模块 | 动态功耗 | 静态功耗 |
|------|----------|----------|
| CAN Top (4ch) | 50mW | 10mW |
| 每通道 | 10mW | 2mW |

---

## 10. 验证需求

### 10.1 DV 准入标准

| 覆盖率类型 | 目标 | 备注 |
|------------|------|------|
| 代码覆盖率 | 100% | 所有分支/语句 |
| 功能覆盖率 | 100% | 所有功能点 |
| 断言覆盖率 | 100% | 所有协议断言 |

### 10.2 测试用例

| 类别 | 用例数 | 说明 |
|------|--------|------|
| 协议测试 | 50+ | CAN 2.0 / CAN FD |
| 功能测试 | 100+ | 功能验证 |
| 异常测试 | 50+ | 错误注入 |
| 压力测试 | 20+ | 长时间运行 |
| 低功耗测试 | 10+ | 休眠/唤醒 |

---

## 11. 交付物清单

| 交付物 | 文件名 | 状态 |
|--------|--------|------|
| 架构文档 | 12_Peripheral_Subsystem_Architecture.md | 完成 |
| Feature List | FEATURE_LIST.md | 本文档 |
| RTL 代码 | *.sv | 进行中 |
| SDC 约束 | can.sdc | 进行中 |
| UVM 环境 | uvm_env/ | 待开发 |
| 测试计划 | testplan_block/ | 待开发 |

---

**文档版本**: V1.0  
**创建日期**: 2026-01-19  
**状态**: 开发中  
**下一步**: RTL 代码开发
