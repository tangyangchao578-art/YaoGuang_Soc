# Feature List - PCIe Gen4 Controller

## 基本信息
| 项目 | 内容 |
|------|------|
| **模块名称** | pcie_controller |
| **版本** | V1.0 |
| **作者** | 前端设计团队 |
| **创建日期** | 2026-01-19 |
| **关联Spec版本** | V1.0 |

---

## Feature列表

| ID | Feature描述 | 优先级 | 验证类型 | 依赖项 | 验收标准 |
|----|------------|--------|----------|--------|----------|
| FE_001 | PCIe Gen4 x8/x4 通道支持 | P0 | 功能 | 无 | x8/x4模式切换正常，链路训练成功 |
| FE_002 | TLP事务层处理（Memory Read/Write） | P0 | 功能 | 无 | Memory读写事务完整，响应正确 |
| FE_003 | TLP事务层处理（Configuration Read/Write） | P0 | 功能 | 无 | 配置空间访问正确，BAR映射正常 |
| FE_004 | TLP事务层处理（Completion） | P0 | 功能 | 无 | Completion返回正确，数据完整 |
| FE_005 | DLLP数据链路层（Ack/Nak协议） | P0 | 功能 | FE_001 | Ack/Nak正确，序列号递增 |
| FE_006 | 流量控制（Flow Control） | P0 | 功能 | 无 | 信用机制工作正常，无死锁 |
| FE_007 | 128b/130b编码/解码 | P0 | 功能 | 无 | 编解码正确，同步稳定 |
| FE_008 | 扰码/解扰（Scrambler） | P1 | 功能 | FE_007 | 扰码功能正常，模式切换正常 |
| FE_009 | 链路训练状态机（LTSSM） | P0 | 功能 | 无 | 完整训练流程，状态跳转正确 |
| FE_010 | MSI/MSI-X中断支持 | P1 | 功能 | 无 | 中断产生正确，矢量正确 |
| FE_011 | SR-IOV支持（64 VF） | P2 | 功能 | FE_003 | VF创建、删除正常 |
| FE_012 | ATS地址转换服务 | P2 | 功能 | FE_002 | 地址转换正确 |
| FE_013 | 电源管理状态（D0/D1/D2/D3） | P1 | 功能 | 无 | 状态切换正常，恢复正确 |
| FE_014 | 错误检测与报告（Correctable/Non-fatal/Fatal） | P0 | 异常 | 无 | 错误检测正确，中断产生 |
| FE_015 | 奇偶校验错误注入 | P1 | 异常 | 无 | 错误注入后检测到，状态机恢复 |
| FE_016 | 超时重试机制 | P1 | 异常 | FE_005 | 超时后触发重试，Nak处理正常 |
| FE_017 | 电空闲（Electrical Idle）控制 | P1 | 功能 | FE_009 | 电空闲进入/退出正常 |
| FE_018 | 通道极性反转校正 | P2 | 功能 | FE_009 | 极性反转时自动校正 |
| FE_019 | AXI4 Master接口（Memory映射访问） | P0 | 功能 | 无 | AXI事务正确发起/完成 |
| FE_020 | AXI4 Slave接口（配置空间访问） | P0 | 功能 | 无 | 配置寄存器读写正确 |
| FE_021 | 最大Payload Size配置（128/256/512B） | P1 | 配置 | 无 | 配置生效，传输正常 |
| FE_022 | 最大Read Request Size配置（4KB） | P1 | 配置 | 无 | 配置生效，分包正确 |
| FE_023 | Link Speed/Width协商 | P0 | 功能 | FE_009 | 速度和宽度正确协商 |
| FE_024 | 带宽利用率测试（>80%） | P2 | 性能 | 无 | 吞吐量达到理论值80%以上 |

---

### FE_001: PCIe Gen4 x8/x4 通道支持
- **描述**: 支持PCIe Gen4 x8主通道和x4辅助通道，通道宽度可配置
- **前置条件**: PHY时钟使能，链路训练启动
- **测试步骤**:
  1. 配置通道数为x8
  2. 启动链路训练
  3. 检查link_width状态
  4. 切换到x4模式
  5. 检查link_width状态
- **预期结果**: 
  - x8模式下link_width=8
  - x4模式下link_width=4
- **边界条件**: 通道故障时降级
- **关联需求**: 架构规格3.1

### FE_002: TLP事务层处理（Memory Read/Write）
- **描述**: 处理Memory Read和Memory Write事务，包括Header构建和Data转发
- **前置条件**: 链路已建立，配置空间已初始化
- **测试步骤**:
  1. 发起Memory Write请求
  2. 检查TLP Header格式
  3. 等待Completion
  4. 发起Memory Read请求
  5. 检查返回数据和Completion
- **预期结果**: 
  - TLP格式正确
  - 数据完整无错误
- **边界条件**: 超出Max Payload Size时分包
- **关联需求**: 架构规格3.1

### FE_003: TLP事务层处理（Configuration Read/Write）
- **描述**: 处理Configuration Space访问，支持Type 0和Type 1请求
- **前置条件**: 链路已建立
- **测试步骤**:
  1. 发起Configuration Read请求
  2. 检查返回数据
  3. 发起Configuration Write请求
  4. 回读验证
- **预期结果**: 配置空间读写正确
- **边界条件**: 访问非法地址时返回UR
- **关联需求**: 架构规格3.1

### FE_004: TLP事务层处理（Completion）
- **描述**: 处理Completion包，包括带数据和不带数据的Completion
- **前置条件**: 已发起Read请求
- **测试步骤**:
  1. 发起Memory Read请求
  2. 检查Completion状态
  3. 检查数据完整性
- **预期结果**: Completion正确返回
- **关联需求**: 架构规格3.1

### FE_005: DLLP数据链路层（Ack/Nak协议）
- **描述**: 实现数据链路层Ack/Nak协议，保证TLP可靠传输
- **前置条件**: 链路已建立
- **测试步骤**:
  1. 发送多个TLP
  2. 模拟丢包
  3. 检查Nak处理
  4. 检查重传
- **预期结果**: 无丢包，数据完整
- **关联需求**: 架构规格3.1

### FE_006: 流量控制（Flow Control）
- **描述**: 实现流量控制机制，管理Credit分配
- **前置条件**: 链路初始化完成
- **测试步骤**:
  1. 监控FC Credit可用性
  2. 发送大量请求耗尽Credit
  3. 检查流控机制
- **预期结果**: Credit正确管理，无溢出
- **关联需求**: 架构规格3.1

### FE_007: 128b/130b编码/解码
- **描述**: 实现PCIe Gen4必需的128b/130b编码/解码
- **前置条件**: 物理层同步完成
- **测试步骤**:
  1. 注入数据
  2. 检查编码输出
  3. 检查解码恢复
- **预期结果**: 编解码正确
- **关联需求**: 架构规格3.1

### FE_008: 扰码/解扰（Scrambler）
- **描述**: 实现数据扰码功能，减少EMI和DC平衡
- **前置条件**: FE_007
- **测试步骤**:
  1. 启用扰码
  2. 检查扰码输出
  3. 禁用扰码对比
- **预期结果**: 扰码功能正常
- **关联需求**: 架构规格3.1

### FE_009: 链路训练状态机（LTSSM）
- **描述**: 实现完整的PCIe链路训练状态机
- **前置条件**: PHY就绪
- **测试步骤**:
  1. 启动链路训练
  2. 监控LTSSM状态跳转
  3. 进入L0状态
- **预期结果**: 状态机完整运行，成功进入L0
- **边界条件**: 训练失败时进入Recovery
- **关联需求**: 架构规格3.1

### FE_010: MSI/MSI-X中断支持
- **描述**: 支持MSI和MSI-X中断机制
- **前置条件**: 配置空间初始化
- **测试步骤**:
  1. 配置MSI Capability
  2. 触发中断
  3. 检查中断信号
- **预期结果**: 中断正确产生
- **关联需求**: 架构规格3.1

### FE_011: SR-IOV支持（64 VF）
- **描述**: 支持Single Root I/O Virtualization，最多64个Virtual Function
- **前置条件**: FE_003
- **测试步骤**:
  1. 配置SR-IOV Enable
  2. 创建VF
  3. 访问VF配置空间
- **预期结果**: VF正常创建和访问
- **关联需求**: 架构规格3.1

### FE_012: ATS地址转换服务
- **描述**: 支持Address Translation Service，用于IOMMU
- **前置条件**: FE_002
- **测试步骤**:
  1. 配置ATS Capability
  2. 发起Translate Request
  3. 检查Translate Response
- **预期结果**: 地址转换正确
- **关联需求**: 架构规格3.1

### FE_013: 电源管理状态（D0/D1/D2/D3）
- **描述**: 支持PCIe电源管理状态切换
- **前置条件**: 链路已建立
- **测试步骤**:
  1. 从D0切换到D3
  2. 检查Electrical Idle
  3. 从D3切换回D0
  4. 检查链路恢复
- **预期结果**: 状态切换正常，链路恢复
- **关联需求**: 架构规格3.1

### FE_014: 错误检测与报告
- **描述**: 实现错误检测和报告机制（Correctable/Non-fatal/Fatal）
- **前置条件**: 链路已建立
- **测试步骤**:
  1. 注入奇偶校验错误
  2. 检查错误检测
  3. 检查错误中断
- **预期结果**: 错误检测正确，报告及时
- **关联需求**: 架构规格3.1

### FE_015: 奇偶校验错误注入
- **描述**: 支持TLP/DLLP奇偶校验错误注入测试
- **前置条件**: FE_014
- **测试步骤**:
  1. 配置错误注入
  2. 发送TLP
  3. 检查错误检测
- **预期结果**: 注入错误被检测到
- **关联需求**: 架构规格3.1

### FE_016: 超时重试机制
- **描述**: 实现Ack超时和重传机制
- **前置条件**: FE_005
- **测试步骤**:
  1. 禁用Ack
  2. 等待超时
  3. 检查重传
- **预期结果**: 超时后触发重传
- **关联需求**: 架构规格3.1

### FE_017: 电空闲（Electrical Idle）控制
- **描述**: 实现Electrical Idle进入/退出控制
- **前置条件**: FE_009
- **测试步骤**:
  1. 触发Electrical Idle
  2. 检查TX信号
  3. 退出Electrical Idle
  4. 检查链路恢复
- **预期结果**: 电空闲控制正常
- **关联需求**: 架构规格3.1

### FE_018: 通道极性反转校正
- **描述**: 自动检测和校正通道极性反转
- **前置条件**: FE_009
- **测试步骤**:
  1. 反转某一通道极性
  2. 检查自动校正
  3. 检查链路建立
- **预期结果**: 极性自动校正
- **关联需求**: 架构规格3.1

### FE_019: AXI4 Master接口
- **描述**: 实现AXI4 Master接口，支持Memory映射访问
- **前置条件**: 无
- **测试步骤**:
  1. 发起AXI Read
  2. 发起AXI Write
  3. 检查响应
- **预期结果**: AXI事务正确
- **关联需求**: 架构规格3.1

### FE_020: AXI4 Slave接口
- **描述**: 实现AXI4 Slave接口，支持配置空间访问
- **前置条件**: 无
- **测试步骤**:
  1. 发起AXI Read到配置空间
  2. 发起AXI Write到配置空间
  3. 检查返回数据
- **预期结果**: 配置访问正确
- **关联需求**: 架构规格3.1

### FE_021: 最大Payload Size配置
- **描述**: 支持配置Max Payload Size（128/256/512字节）
- **前置条件**: FE_003
- **测试步骤**:
  1. 配置MPS为256
  2. 发送256字节数据包
  3. 检查正确接收
- **预期结果**: 配置生效
- **关联需求**: 架构规格3.1

### FE_022: 最大Read Request Size配置
- **描述**: 支持配置Max Read Request Size（最大4KB）
- **前置条件**: FE_002
- **测试步骤**:
  1. 配置MRRS为4KB
  2. 发起4KB Read请求
  3. 检查分包
- **预期结果**: 分包正确
- **关联需求**: 架构规格3.1

### FE_023: Link Speed/Width协商
- **描述**: 支持Link Speed和Width的协商
- **前置条件**: FE_009
- **测试步骤**:
  1. 启动链路训练
  2. 检查协商速度
  3. 检查协商宽度
- **预期结果**: 协商正确
- **关联需求**: 架构规格3.1

### FE_024: 带宽利用率测试
- **描述**: 测试实际带宽利用率
- **前置条件**: FE_001, FE_002
- **测试步骤**:
  1. 连续发送最大包
  2. 测量实际吞吐量
  3. 计算利用率
- **预期结果**: 利用率>80%
- **关联需求**: 架构规格3.1

---

## 验证资源估算

| 类别 | 数量 | 备注 |
|------|------|------|
| **功能测试用例** | 50+ | TLP/DLLP处理 |
| **异常测试用例** | 20+ | 错误注入 |
| **配置测试用例** | 10+ | 模式切换 |
| **性能测试用例** | 5+ | 带宽测试 |
| **仿真时间预估** | 500+小时 | 回归测试 |

---

## 追溯矩阵

| Feature ID | 架构需求 | 设计规格 |
|------------|----------|----------|
| FE_001 | 3.1.1 | 5.1.1 |
| FE_002 | 3.1.2 | 5.1.2 |
| FE_003 | 3.1.3 | 5.1.3 |
| FE_004 | 3.1.2 | 5.1.2 |
| FE_005 | 3.1.4 | 5.1.4 |
| FE_006 | 3.1.5 | 5.1.5 |
| FE_007 | 3.1.6 | 5.1.6 |
| FE_008 | 3.1.6 | 5.1.6 |
| FE_009 | 3.1.7 | 5.1.7 |
| FE_010 | 3.1.8 | 5.1.8 |

---

**文档版本**: V1.0  
**创建日期**: 2026-01-19  
**状态**: 已交付DV
