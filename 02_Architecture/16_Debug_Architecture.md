# 摇光(YaoGuang) SoC 调试架构规格文档

## Document Information

| Field | Value |
|-------|-------|
| Document ID | ARCH-DBG-001 |
| Version | 1.0 |
| Author | YaoGuang Architecture Team |
| Date | 2026-01-18 |
| Status | Draft |
| Classification | Internal |

## 1. 概述

### 1.1 文档目的

本文档定义了摇光(YaoGuang)车规级SoC芯片的调试架构规格，涵盖硬件调试接口、CoreSight调试系统、调试功能模块以及系统级调试能力。本架构基于ARM CoreSight技术标准和IEEE 1149.1 JTAG规范，旨在为自动驾驶处理器提供符合ISO 26262 ASIL-D要求的完整调试解决方案。

调试架构是芯片开发过程中不可或缺的核心基础设施，它不仅支撑软件开发阶段的固件调试和性能优化，更是量产车辆中故障诊断和现场分析的关键能力。摇光SoC作为面向L3+/L4级自动驾驶的高性能处理器，其调试系统需要同时满足开发阶段的高带宽跟踪需求和量产阶段的有限调试能力要求。本规格文档将从系统级视角出发，逐层分解调试架构的各个组成部分，明确接口规范、功能定义和性能指标。

### 1.2 调试架构设计目标

摇光SoC调试架构的设计围绕五个核心目标展开。首先是**完整的调试覆盖**，架构需要支持对CPU核、GPU核、NPU加速器、DMA控制器、外设以及片上总线的全面调试能力。其次是**高带宽跟踪能力**，在系统全速运行时，跟踪系统需要能够捕获足够的数据以支持复杂的性能分析和算法调试，单核跟踪带宽不低于4GB/s。第三是**灵活的配置模式**，调试系统需要在侵入式调试（断点、暂停）和非侵入式跟踪（零停机监控）之间提供平滑的过渡和选择。第四是**符合车规安全要求**，调试功能的使能控制、安全特权级别、访问权限管理需要满足ISO 26262 ASIL-D的要求。最后是**可扩展的架构**，调试系统需要支持未来的IP升级和扩展，无需对整体架构进行重大修改。

### 1.3 术语定义

| 术语 | 定义 |
|------|------|
| CoreSight | ARM提供的片上调试和跟踪架构规范 |
| DAP | Debug Access Port，调试访问端口 |
| JTAG | Joint Test Action Group，IEEE 1149.1标准调试接口 |
| SWD | Serial Wire Debug，串行线调试接口 |
| ETM | Embedded Trace Macrocell，嵌入式跟踪宏单元 |
| ITM | Instrumentation Trace Macrocell，仪器化跟踪宏单元 |
| TPIU | Trace Port Interface Unit，跟踪端口接口单元 |
| STM | System Trace Macrocell，系统跟踪宏单元 |
| HTM | Halt Mode Debug，停机模式调试 |
| Run Mode Debug | 运行模式调试 |

## 2. 系统架构总览

### 2.1 调试架构层次模型

摇光SoC调试架构采用四层层次模型，从物理接口层到应用交互层逐层抽象，形成完整的调试能力栈。最底层是**物理接口层**，包含JTAG和SWD两种调试接口的物理实现，以及高速跟踪端口的SERDES物理层。第二层是**调试访问层**，实现DAP（Debug Access Port）作为所有调试访问的统一入口，支持对系统总线和内存映射寄存器的访问。第三层是**CoreSight互连层**，构建调试组件之间的连接矩阵，实现跟踪数据的路由和汇聚。第四层是**功能组件层**，包含各类调试和跟踪功能的硬件实现。

这种层次化设计带来了显著的架构优势。物理接口层与功能组件层的解耦使得调试接口可以在不影响内部调试功能的情况下进行升级或替换。调试访问层的抽象为上层软件提供了统一的编程模型，无论底层使用何种物理接口。CoreSight互连层的标准化确保了不同来源的调试IP能够无缝集成。功能组件层的模块化设计便于根据产品定位进行配置裁剪。

### 2.2 调试架构框图

```
                              ┌─────────────────────────────┐
                              │     External Debug Probe    │
                              │   (JTAG / SWD / Trace)      │
                              └──────────┬──────────────────┘
                                         │
                    ┌────────────────────┼────────────────────┐
                    │                    │                    │
           ┌────────▼────────┐  ┌───────▼────────┐  ┌────────▼────────┐
           │  JTAG Physical  │  │  SWD Physical  │  │  Trace Physical │
           │    Interface    │  │    Interface   │  │    Interface    │
           └────────┬────────┘  └───────┬────────┘  └────────┬────────┘
                    │                   │                    │
                    └─────────────────┬─┘                    │
                                      │                      │
                              ┌───────▼────────┐              │
                              │      DAP       │              │
                              │  (AHB/APB/AXI) │              │
                              └───────┬────────┘              │
                                      │                      │
                    ┌─────────────────┼──────────────────────┘
                    │                 │
         ┌──────────▼──────────┐     │
         │   CoreSight Matrix  │◄────┘
         │   (Crossbar Switch) │
         └──────────┬──────────┘
                    │
    ┌───────────────┼───────────────┬───────────────┬───────────────┐
    │               │               │               │               │
┌───▼───┐     ┌─────▼─────┐   ┌─────▼─────┐   ┌─────▼─────┐   ┌─────▼─────┐
│  CPU0 │     │  CPU1     │   │   CPU2    │   │   CPU3    │   │   NPU     │
│  ETM  │     │   ETM     │   │   ETM     │   │   ETM     │   │   ETM     │
└───┬───┘     └─────┬─────┘   └─────┬─────┘   └─────┬─────┘   └─────┬─────┘
    │               │               │               │               │
    └───────────────┴───────────────┴───────────────┴───────────────┘
                                    │
                    ┌───────────────┼───────────────┐
                    │               │               │
            ┌───────▼─────┐  ┌──────▼─────┐  ┌───────▼─────┐
            │  ITM/STM    │  │   TPIU     │  │   ETM       │
            │  Aggregator │  │            │  │  Aggregator │
            └──────┬──────┘  └─────┬──────┘  └──────┬──────┘
                   │               │                │
                   └───────────────┼────────────────┘
                                   │
                            ┌──────▼──────┐
                            │ Trace Buffer│
                            │ (8MB SRAM)  │
                            └─────────────┘
```

### 2.3 调试总线矩阵

调试总线矩阵是整个调试架构的骨干基础设施，它连接了DAP访问端口与所有调试组件。矩阵采用crossbar-switch架构，支持多主设备同时访问不同的从设备，目标带宽满足以下要求：单端口峰值带宽16GB/s（256位@500MHz），总聚合带宽64GB/s，支持8路并发访问，访问延迟小于10个时钟周期。

矩阵的访问仲裁采用轮询+优先级相结合的策略。对于实时性要求高的跟踪数据流，采用预留带宽的方式保证其传输优先级。对于配置寄存器的访问，采用加权轮询仲裁，确保各主设备的公平访问。矩阵支持地址窗口映射，不同的调试组件被映射到DAP地址空间的特定区域，上位机软件可以通过标准的内存访问命令实现对调试组件的完全控制。

## 3. 调试接口规格

### 3.1 JTAG接口

#### 3.1.1 电气特性

摇光SoC的JTAG接口遵循IEEE 1149.1-2013标准，支持边界扫描测试和调试访问的双重功能。考虑到车规级应用的环境要求，JTAG接口的电气特性定义如下：

| Parameter | Min | Typ | Max | Unit |
|-----------|-----|-----|-----|------|
| TCK Frequency | 0 | 10 | 20 | MHz |
| TDI Setup Time | 5 | - | - | ns |
| TDI Hold Time | 5 | - | - | ns |
| TDO Delay | - | - | 10 | ns |
| TRST Assert Time | 100 | - | - | ns |

JTAG接口采用标准5线信号配置：TCK（测试时钟）、TMS（测试模式选择）、TDI（测试数据输入）、TDO（测试数据输出）、TRST（测试复位，可选）。考虑到与其他车规芯片的兼容性，推荐使用TRST信号进行复位。TCK最大工作频率20MHz，虽然低于某些高端调试接口，但完全满足IEEE 1149.1标准要求，且提供了更好的信号完整性。

#### 3.1.2 TAP控制器状态机

JTAG接口的TAP（Test Access Port）控制器实现标准的16状态状态机，状态转移遵循IEEE 1149.1规范。状态机支持以下指令：

| Instruction | Opcode | Function |
|-------------|--------|----------|
| BYPASS | 0xFFFF | 绕过当前器件 |
| IDCODE | 0x0001 | 读取芯片识别码 |
| SAMPLE/PRELOAD | 0x0003 | 边界扫描采样 |
| EXTEST | 0x0000 | 外部边界扫描 |
| INTEST | 0x000F | 内部测试 |
| DEBUG | 0x1234 | 调试访问使能 |
| HIGHZ | 0x5555 | 高阻态控制 |

芯片IDCODE寄存器（32位）格式定义如下：版本号（4位，bit[31:28]）、部件号（16位，bit[27:12]）、制造商ID（11位，bit[11:1]）、总是1（1位，bit[0]）。

#### 3.1.3 JTAG调试协议

摇光SoC实现了基于JTAG的调试协议扩展，支持通过JTAG接口访问CoreSight调试组件。调试协议采用两种访问模式：直接寄存器访问模式用于配置调试组件的操作参数，数据传输模式用于读取跟踪数据和写入调试数据。

调试协议的命令包格式为：包起始标志（1位，0x1）、读/写标志（1位）、地址（18位）、数据长度（4位，可选）、数据（32/64位，可选）。响应包格式为：包起始标志（1位，0x1）、状态（2位）、数据（32/64位，可选）。协议支持流水线操作，最多允许4个未完成的请求。

### 3.2 SWD接口

#### 3.2.1 物理层规格

Serial Wire Debug（SWD）是ARM定义的串行调试接口，相比传统的JTAG接口，它仅需要2根信号线（SWDIO和SWCLK）即可完成调试访问，同时支持更高的时钟频率。摇光SoC的SWD接口规格如下：

| Parameter | Min | Typ | Max | Unit |
|-----------|-----|-----|-----|------|
| SWCLK Frequency | 0 | 50 | 100 | MHz |
| SWDIO Turnaround | 1 | - | - | SWCLK |
| SWDIO Drive Strength | - | 4 | - | mA |
| Pull-up Resistor | 40 | 47 | 56 | kΩ |

SWD接口的电气特性符合ARM Debug Interface v5规范，支持3.3V和1.8V两种I/O电压标准。接口内部集成上拉电阻，无需外部上拉。SWDIO信号采用双向开漏设计，多个设备可以共享同一组调试信号。

#### 3.2.2 SWD传输协议

SWD协议采用帧结构进行数据传输，每帧包含以下字段：主机请求相位（8位，包含APnDP、RNW、地址信息）、确认相位（3位+填充位）、数据传输相位（33位，包含32位数据+奇偶校验）、停止相位（1位，置1）。

请求相位字段定义如下：APnDP（1位，选择AP或DP）、RNW（1位，读或写）、A[2:3]（2位，地址位2-3）、Parity（1位，前面4位的奇偶校验）、Stop（1位，必须为0）、Park（1位，必须为1）。确认相位返回值定义：OK（001）、WAIT（010）、FAULT（100）。

SWD协议支持两种高级功能：JTAG-to-SWD切换协议和SWD握手机制。JTAG-to-SWD切换协议允许在系统上电后通过发送特定序列将JTAG接口切换为SWD模式。SWD握手机制用于在AP访问超时的情况下中止当前操作并返回就绪状态。

#### 3.2.3 SWD与JTAG互操作

为了支持同时连接JTAG和SWD调试器的混合使用场景，摇光SoC实现了JTAG/SWD接口的互操作机制。默认情况下，系统检测到有效的SWD切换序列后自动切换到SWD模式，检测到有效的JTAG序列后自动切换到JTAG模式。模式切换由硬件自动完成，无需软件干预。

在双接口同时连接的情况下，优先级规则如下：DAP访问的优先级相同，谁先发起请求谁先获得总线；跟踪端口数据仍然通过TPIU输出，不受调试接口影响；两个接口可以同时访问不同的调试组件，但禁止同时访问同一组件。

### 3.3 跟踪接口

#### 3.3.1 TPIU规格

Trace Port Interface Unit（TPIU）是CoreSight架构中负责将跟踪数据输出到芯片外部的组件。摇光SoC实现增强型TPIU，支持多种跟踪模式和编码方案。

TPIU的核心规格如下：输出端口宽度可选8/16/32位，跟踪时钟频率200MHz（8位模式）或100MHz（16位模式）或50MHz（32位模式），最大跟踪带宽8Gbps（8位@1GHz DDR），支持连续和突发两种传输模式，内置8KB FIFO用于吸收带宽波动。

跟踪端口采用低压差分信号（LVDS）驱动，信号规格符合IEEE 1596.3标准。跟踪时钟采用嵌入式时钟编码方案，数据眼图宽度不小于0.6UI，抖动小于100ps。

#### 3.3.2 跟踪数据编码

跟踪数据采用ARM定义的Embedded Trace Bus（ETB）编码格式。每个跟踪数据包包含以下字段：包长度（2位）、包类型（3位）、时间戳（可选，12-48位）、有效载荷（8-256位）。包类型定义如下：

| Type | Value | Description |
|------|-------|-------------|
| I_SYNC | 0b000 | 同步包，用于建立字节对齐 |
| D_SEQ | 0b001 | 数据序列包，压缩重复数据 |
| I_TRACE_INFO | 0b010 | 跟踪信息包 |
| I_TRACE_ON | 0b011 | 跟踪使能指示 |
| I_TRACE_OFF | 0b100 | 跟踪禁用指示 |
| EJECT | 0b101 | 缓存刷新请求 |
| FLYING_SHADOW | 0b110 | 影子跟踪 |
| CUSTOM | 0b111 | 自定义包 |

为了提高带宽利用率，TPIU支持两种压缩模式：空包压缩和重复数据压缩。空包压缩移除连续的空数据传输周期，减少无效开销。重复数据压缩对连续相同的字节进行run-length编码，将重复次数作为有效载荷传输。

#### 3.3.3 跟踪端口模式配置

TPIU支持多种跟踪端口模式以适应不同的调试器和PCB设计：

| Mode | Data Width | Clock | Bandwidth | Use Case |
|------|------------|-------|-----------|----------|
| 8-bit SDR | 8 | 200MHz | 1.6Gbps | 标准4线连接 |
| 8-bit DDR | 8 | 200MHz | 3.2Gbps | 高速跟踪 |
| 16-bit SDR | 16 | 100MHz | 3.2Gbps | 中等复杂度设计 |
| 16-bit DDR | 16 | 100MHz | 6.4Gbps | 高带宽需求 |
| 32-bit SDR | 32 | 50MHz | 3.2Gbps | 低速长距离 |
| 32-bit DDR | 32 | 50MHz | 6.4Gbps | 通用高速 |

模式选择通过配置寄存器进行，软件可以在运行时动态切换跟踪端口模式以适应不同的调试场景。

## 4. CoreSight调试系统

### 4.1 DAP架构

Debug Access Port（DAP）是调试系统与外部调试器之间的桥梁，它是所有调试访问的入口点。摇光SoC实现完整的CoreSight DAP架构，包含APB Access Port（APB-AP）、AHB Access Port（AHB-AP）和AXI Access Port（AXI-AP）三种访问端口。

DAP的内部架构由三部分组成：DP（Debug Port）负责物理接口的适配和协议转换，ADB（AHB/AXI Debug Bus）负责调试总线的仲裁和路由，AP（Access Port）负责具体存储器类型的访问。DP内部集成16KB ROM表，存储了DAP的标识信息和AP的地址映射表，调试器可以通过读取ROM表自动发现系统中的调试组件。

DAP的访问性能指标如下：APB-AP访问延迟小于20个时钟周期，AHB-AP访问延迟小于30个时钟周期，AXI-ID最大支持16（支持8个Outstanding请求），访问带宽在AXI-64位@200MHz配置下达到12.8Gbps。

### 4.2 CoreSight组件

#### 4.2.1 CPU调试组件

摇光SoC的每个CPU核集成完整的CoreSight调试组件，支持所有标准的调试功能：

**断点单元（Breakpoint Unit, BPU）**：每个CPU支持4个硬件断点，支持以下断点类型：执行断点（在指定地址停止执行）、访问断点（在指定地址的读/写操作时触发）、条件断点（仅当满足附加条件时触发）。断点地址支持4字节对齐的任意地址，断点条件可配置为总是触发、匹配地址范围或匹配特定的数据值。

**观察点单元（Watchpoint Unit, WPU）**：每个CPU支持4个硬件观察点，观察点可以配置为监控数据总线地址、数据值或两者的组合。观察点支持以下触发模式：读访问触发、写访问触发、读/写访问触发、数据值匹配触发。观察点触发后可以产生调试异常或仅设置状态标志。

**调试状态控制**：CPU调试状态机实现标准的CoreSight调试状态模型，包括运行状态、暂停状态（halted）、单步执行状态和调试监控模式状态。状态转换可以通过以下方式触发：外部调试器请求、断点/观察点命中、单步执行完成。调试状态的变化会反映在CPU状态寄存器中，同时产生调试状态改变事件。

#### 4.2.2 跟踪宏单元

**Embedded Trace Macrocell (ETM)**：每个CPU核配置独立的ETM，支持完整的指令跟踪和数据跟踪功能。ETM的核心规格如下：指令跟踪支持条件执行压缩，可选压缩级别包括完全压缩（仅跟踪分支目标）、基本压缩（跟踪所有分支）、无压缩（完整指令流）。数据跟踪支持选择性数据跟踪，可以配置仅跟踪特定地址范围或特定数据类型的数据访问。ETM输出采用64位数据总线，最大输出带宽8GB/s。

ETM支持多种跟踪模式：分支历史跟踪（Branch History，BHT）模式压缩存储分支方向和目标，提高跟踪效率；周期精确跟踪（Cycle Accurate）模式提供指令执行的精确时序信息；事件跟踪（Event Trace）模式仅跟踪系统事件而非每条指令。

**Instrumentation Trace Macrocell (ITM)**：ITM提供软件驱动的跟踪能力，允许固件通过写入ITM寄存器输出调试信息。ITM支持8个优先级通道，不同通道的跟踪数据可以独立使能和过滤。ITM还集成了硬件数据跟踪功能，可以监控DMA传输和外部总线访问。ITM支持时间戳插入，时间戳精度为系统时钟周期。

**System Trace Macrocell (STM)**：STM提供跨核的系统级跟踪能力，适合跟踪多核系统的交互和同步行为。STM支持8个主设备（对应8个CPU核或加速器），每个主设备支持256个软件通道。STM的跟踪数据可以携带主机ID、时间戳和源位置信息，便于在上位机软件中进行多线程跟踪的关联和分析。

#### 4.2.3 跟踪聚合与输出

跟踪聚合器负责收集来自所有ETM、ITM和STM的跟踪数据，进行格式化处理后输出到TPIU或内部跟踪缓存。聚合器的核心功能包括：多源数据的时分复用、带宽均衡和流量控制、压缩编码、空闲周期消除、错误检测和报告。

聚合器支持两种工作模式：直通模式下跟踪数据实时通过TPIU输出，延迟小于10个时钟周期，适合高带宽实时跟踪；缓存模式下跟踪数据先写入内部跟踪缓存，缓存满或软件触发后批量读取，适合有限带宽场景下的完整跟踪。

聚合器的调度算法采用加权轮询策略，带权分配基于各数据源的使能状态和优先级配置。默认配置下，CPU0-3的ETM各获得25%的基础带宽，ITM和STM共享剩余25%带宽。

### 4.3 调试组件互连

CoreSight组件之间通过ATB（AMBA Trace Bus）总线进行互连。ATB总线采用点对点连接或共享总线两种拓扑，本设计采用混合拓扑：对于带宽需求高的组件（如ETM到聚合器）采用点对点连接，对于访问频率低但节点多的组件（如配置寄存器）采用共享总线。

ATB协议基于VALID/READY握手机制，支持多主设备同时发起传输。ATB总线的信号定义包括：ATVALID（源设备就绪）、ATREADY（目标设备就绪）、ATID（源设备标识）、ATDATA（数据，32/64/128位可配置）、ATLAST（包结束标志）。ATB总线工作在100MHz时钟域，数据位宽64位，单端口峰值带宽800MB/s。

调试组件之间的地址映射采用静态配置方式，每个组件的寄存器空间在系统地址映射中有固定的偏移地址。地址映射表由ROM表提供，调试器通过读取ROM表自动发现所有可用的调试组件。

## 5. 调试功能规格

### 5.1 断点功能

#### 5.1.1 硬件断点

硬件断点是通过CPU内部硬件实现的执行控制机制，它在指令流水线的早期阶段检测断点条件，无需修改程序代码即可实现调试断点。摇光SoC的每个CPU核支持4个硬件断点，每个断点可以独立配置。

断点配置寄存器的字段定义如下：EN位（bit[0]，断点使能）、TYPE位（bit[1]，0=执行断点，1=访问断点）、MODE位（bit[2]，0=用户模式，1=特权模式，2=两种模式）、BADDR字段（bit[31:3]，断点地址，8字节对齐）、BMATCH字段（bit[63:32]，数据匹配值，仅访问断点使用）。

硬件断点的工作流程分为三个阶段。断点设置阶段：调试器通过DAP写入断点配置寄存器，配置断点地址和条件。断点检测阶段：CPU取指单元将取指地址与所有使能的断点地址进行比较，匹配成功则阻止指令进入流水线并触发调试异常。断点处理阶段：CPU保存当前执行上下文，跳转到调试异常处理程序或直接进入暂停状态。

断点的响应时间取决于断点配置和CPU状态。对于执行断点，在取指阶段检测，平均延迟小于5个时钟周期。对于访问断点，在内存访问阶段检测，平均延迟小于10个时钟周期。

#### 5.1.2 软件断点

软件断点是通过替换指令为特定断点指令（ARM架构为BKPT）实现的断点机制。软件断点的优点是可以设置任意数量的断点（受内存空间限制），缺点是需要修改程序代码。

软件断点的实现依赖以下机制：断点指令替换（Breakpoint Instruction Replacement，BIR）单元负责将内存中的指令替换为断点指令，当断点命中后恢复原始指令。断点指令缓存存储被替换的原始指令，支持精确恢复。断点地址表记录所有软件断点的位置和状态。

软件断点的触发过程：当CPU执行到BKPT指令时，产生调试异常。调试异常处理程序判断是否为软件断点（通过断点地址表查询），如果是则进入暂停状态并通知调试器。调试器完成检查后，可以选择恢复执行（恢复原始指令并临时禁用断点）或继续单步执行。

软件断点与硬件断点的协调由调试状态机统一管理。当硬件断点与软件断点地址重叠时，优先处理硬件断点。当软件断点替换导致地址对齐问题时，系统自动使用等效的硬件断点替代。

#### 5.1.3 条件断点

条件断点允许在断点触发前评估附加条件，只有条件满足时才真正停止CPU执行。条件断点的引入显著提高了复杂调试场景的效率，避免了因重复条件满足而频繁中断调试过程。

条件断点支持的比较操作包括：相等比较（==）、不等比较（!=）、大于比较（>）、小于比较（<）、范围比较（in [min, max]）、掩码比较（mask & value == mask & pattern）。条件表达式支持逻辑组合，最多支持4个条件的AND/OR组合。

条件断点的硬件实现采用比较器阵列方式，每个断点单元集成2个比较器，分别用于地址比较和数据比较。比较器工作频率与CPU内核频率相同，条件评估的额外延迟小于2个时钟周期。

### 5.2 观察点功能

#### 5.2.1 数据访问监控

观察点用于监控CPU或DMA的数据访问行为，当访问地址或访问数据满足预设条件时触发调试事件。摇光SoC的每个CPU核支持4个观察点，所有观察点共享同一套配置寄存器但独立工作。

观察点配置寄存器支持以下配置项：观察点使能（EN）、监控类型（TYPE：0=地址监控，1=数据监控，2=地址+数据监控）、访问类型（ACCESS：0=读，1=写，2=读/写）、地址匹配（ADDR，32位，支持4字节对齐）、地址掩码（ADDR_MSK，用于范围监控）、数据匹配（DATA，32位）、数据掩码（DATA_MSK，用于位字段监控）。

观察点的监控范围可以是单个地址（精确匹配）或地址范围（通过掩码实现）。地址掩码的灵活性使得观察点可以监控整个内存区域或特定的内存页。数据掩码允许仅监控特定位的变化，适合调试寄存器访问或特定数据结构。

#### 5.2.2 观察点响应

观察点触发后的响应行为可以通过配置选择：设置状态标志（仅记录观察点命中事件，不影响程序执行）、产生调试异常（跳转到调试异常处理程序）、触发跟踪记录（在跟踪流中插入观察点命中事件）、组合响应（同时产生调试异常和跟踪记录）。

观察点事件的记录采用环形缓冲区方式，支持记录最近16次观察点命中事件。每条记录包含：观察点编号（4位）、命中时间戳（64位，纳秒精度）、访问地址（32位）、访问数据（32位）、访问类型（2位）。缓冲区溢出时自动覆盖最旧的记录。

### 5.3 跟踪功能

#### 5.3.1 指令跟踪

指令跟踪是调试系统最重要的功能之一，它记录CPU执行的指令序列，使调试器能够回溯程序执行历史。摇光SoC的ETM提供完整的指令跟踪能力，支持多种跟踪粒度和压缩级别。

**分支跟踪模式**：仅跟踪分支指令的目标地址和方向，不跟踪顺序执行的指令。这种模式下，跟踪数据量与分支频率成正比，对于分支密集的程序可以达到100:1的压缩比。调试器需要配合程序二进制文件重建完整的执行轨迹。

**增强分支跟踪模式**：在分支跟踪的基础上，添加条件分支的条件值（Taken/Not Taken）和间接分支的目标地址值。这种模式提供了更多的重建执行轨迹所需的信息，减少了对程序分析的依赖。

**完整指令跟踪**：跟踪所有执行的指令，包括指令地址和操作数。这种模式产生的数据量最大，但提供了最完整的调试信息，适合复杂问题的深度调试。

#### 5.3.2 数据跟踪

数据跟踪监控特定内存位置或内存区域的访问，将访问事件记录到跟踪流中。数据跟踪的配置粒度包括：地址匹配（精确地址或地址范围）、访问类型（读/写/两者）、数据值匹配（仅当数据满足条件时触发）。

数据跟踪与指令跟踪的关联：每个数据访问事件可以关联到触发该访问的指令地址，使得调试器能够追溯数据的生产者和使用者。这种关联对于调试数据相关的问题（如竞争条件、数据污染）特别有价值。

数据跟踪的带宽管理：由于数据跟踪可能产生大量数据，系统提供优先级机制和带宽限制。低优先级的数据跟踪在总线繁忙时可能被延迟或丢弃，以保护高优先度的指令跟踪不被中断。

#### 5.3.3 性能分析跟踪

性能分析跟踪是数据跟踪的扩展，专门收集用于性能分析的数据，包括：缓存命中率、内存访问延迟、分支预测准确率、流水线 stall 周期。性能分析跟踪的采样策略支持：全量采集（所有事件）、周期采样（每N个事件采集1个）、阈值采样（仅采集超过阈值的事件）。

性能分析跟踪数据的格式针对分析工具优化：每个事件记录包含事件类型（8位）、时间戳（16-64位，可配置）、事件参数（32位）。上位机分析工具可以基于这些数据进行热点识别、瓶颈定位和优化效果评估。

### 5.4 调试模式

#### 5.4.1 停机模式调试

停机模式调试（Halting Mode Debug）是最传统的调试模式，当调试器请求暂停CPU时，CPU立即停止执行指令，进入调试暂停状态。在暂停状态下，调试器可以读写CPU的所有寄存器和内存，完全控制CPU的执行。

停机模式调试的特点包括：调试器完全控制CPU状态，执行完全可预测；支持任意时刻暂停，适合断点调试和单步执行；CPU暂停期间系统其他部分继续运行，可能导致状态不一致；不适合调试时序相关问题。

停机模式的进入方式包括：调试器通过DAP发送暂停请求、断点/观察点命中、外部调试信号（EDBGREQ）。退出方式包括：调试器发送恢复执行请求、单步执行完成。

#### 5.4.2 监控模式调试

监控模式调试（Monitor Mode Debug）将调试异常的处理权交给软件调试监控程序，而非直接进入暂停状态。这种模式允许在不停机的情况下处理调试事件，适合需要保持系统实时性的场景。

监控模式的工作流程：当调试事件发生时，CPU跳转到调试监控异常处理程序（位于可信内存区域），监控程序记录事件信息并根据配置决定后续处理（暂停、单步、忽略或记录后继续）。监控程序可以访问调试寄存器，进行复杂的条件判断和事件过滤。

监控模式的优势：调试事件处理与主程序执行解耦，适合多任务系统的调试；调试逻辑可软件定制，适应不同调试需求；CPU无需完全停止，支持对实时系统的调试。劣势：占用CPU周期和内存资源；调试事件处理有延迟，不适合精确时序调试。

#### 5.4.3 跟踪模式调试

跟踪模式调试（Trace-based Debug）不停止CPU执行，而是通过跟踪记录还原程序执行历史。这种模式对于调试难以复现的间歇性问题和性能分析特别有效。

跟踪模式调试的关键技术是执行轨迹重建：跟踪数据（主要是分支和跳转信息）结合程序二进制文件，可以重建程序的完整执行路径。上位机调试工具将跟踪数据可视化，显示执行流程、时间线、资源使用等信息。

跟踪模式调试的典型应用场景包括：系统崩溃后的尸体解剖（Post-mortem Debug）、长时间运行的程序行为分析、多核系统的并发问题调试、性能热点识别和优化。

## 6. 性能分析能力

### 6.1 性能计数器

摇光SoC集成32个性能计数器，分布于CPU核、加速器和系统总线三个层级。这些计数器用于收集运行时的性能指标数据，支持软件进行性能分析和优化。

**CPU核级性能计数器**（每个CPU核8个）：指令执行计数、缓存命中计数、缓存失效计数、分支指令计数、分支预测失败计数、流水线停顿周期、内存访问延迟、浮点运算计数。

**加速器性能计数器**（每个NPU单元4个）：计算周期计数、内存带宽使用、MAC运算计数、功耗估算值。

**系统级性能计数器**（8个）：总线事务计数、总线带宽使用、DMA传输计数、中断处理时间、内存控制器负载、功耗估算值、热点地址访问统计。

性能计数器的配置通过性能监控控制寄存器进行，支持以下功能：计数器使能/禁用、计数条件配置（计特定事件或所有事件）、计数阈值中断（计数值达到阈值时产生中断）、计数采样（定期保存计数快照）。

### 6.2 带宽监控

带宽监控模块实时测量系统中各个主设备对内存和总线的带宽使用情况，为性能优化和资源分配提供数据支撑。带宽监控覆盖以下路径：CPU指令获取路径、CPU数据访问路径、NPU数据访问路径、DMA传输路径、外设DMA路径。

带宽监控的数据粒度：支持按时间窗口统计（最小窗口1ms）和按地址范围统计。统计指标包括：峰值带宽、平均带宽、总传输量、访问延迟分布。带宽数据可以实时输出到跟踪端口，也可以通过寄存器读取。

带宽监控的硬件实现采用采样计数方式：每个主设备的请求经过时，以配置的概率（可配置1/2, 1/4, 1/8...1/256）递增计数器。采样方式降低了硬件开销，同时通过统计推断可以估计真实的带宽使用。

### 6.3 延迟分析

延迟分析模块收集关键路径的访问延迟数据，支持细粒度的性能瓶颈定位。延迟分析覆盖：缓存访问延迟、内存访问延迟（区分DDR和SRAM）、外设访问延迟、片上互连延迟。

延迟分析的输出包括：最小延迟、最大延迟、平均延迟、直方图分布（可选粒度：1-10周期、11-20周期...）。直方图支持自定义边界配置，可以聚焦于感兴趣的延迟区间。

延迟分析数据通过以下方式使用：跟踪数据关联（延迟事件与指令关联）、阈值告警（延迟超过阈值时产生事件）、采样输出（周期性输出统计结果到跟踪端口）。

## 7. 系统级调试能力

### 7.1 多核调试

摇光SoC作为4核CPU+多加速器的异构系统，其调试架构需要支持多核并发调试场景。多核调试能力包括：所有核的同步暂停和恢复、核间断点联动（一个核断点暂停可选择性地暂停其他核）、跨核跟踪关联（带时间戳和核ID的跟踪数据）。

**同步暂停组**：CPU核可以配置为同步暂停组，组内任一核的暂停请求会暂停整个组。组配置通过同步暂停控制寄存器进行，支持8个独立组，每组可以包含任意核的组合。同步暂停组在调试多线程程序时特别有用。

**跨核断点**：跨核断点允许在一个核上设置断点，当断点命中时自动暂停指定的关联核。跨核断点的配置包括：触发条件（断点编号、匹配条件）、联动核列表（最多4个核）、联动延迟（可选的延迟时间，允许核间同步）。

### 7.2 加速器调试

NPU和DMA等加速器的调试采用与CPU核不同的策略。加速器通常不支持单步执行和断点（因为其执行由CPU调度），但支持跟踪和性能监控。

**NPU调试接口**：NPU提供专用的调试访问端口，支持读取内部状态寄存器、配置跟踪参数、收集性能数据。NPU的跟踪数据包含算子执行时间、输入输出张量形状、计算结果校验等信息。

**DMA调试接口**：DMA控制器提供传输跟踪能力，记录每次传输的源地址、目的地址、传输长度和传输时间。DMA调试支持设置传输完成断点，用于调试DMA相关的同步问题。

### 7.3 系统级跟踪

系统级跟踪将来自所有处理单元的跟踪数据整合，提供完整的系统行为视图。系统级跟踪的关键技术包括：

**全局时间戳**：所有跟踪数据携带统一的全局时间戳，时间戳由系统全局时钟生成，精度1ns。时间戳使得来自不同处理单元的跟踪数据可以在时间轴上对齐，分析跨核交互和时序关系。

**事件关联**：系统定义了标准的事件关联机制，调试器可以根据事件类型（如中断、锁释放、消息发送）将多个核上的事件关联起来，构建完整的系统交互图。

**跟踪压缩**：系统级跟踪的数据量可能非常大，跟踪压缩模块采用无损压缩算法（LZ4）减小数据量，压缩比通常在2:1到4:1之间。压缩在跟踪聚合器中完成，对跟踪数据的语义没有影响。

### 7.4 现场调试与崩溃分析

摇光SoC支持在系统崩溃后通过调试端口读取崩溃现场信息，这种能力对于现场故障诊断至关重要。

**崩溃现场保存**：当系统检测到严重错误（看门狗超时、硬件错误中断、内存ECC错误等）时，调试系统自动执行以下操作：保存所有CPU核的寄存器状态到保留内存区域、冻结跟踪缓冲区（保留崩溃前的跟踪数据）、记录错误状态寄存器信息。

**现场调试协议**：调试器连接后，通过特定的调试命令读取保存的现场数据。协议支持读取完整现场映像或仅读取摘要信息（快速诊断模式）。现场数据读取完成后，可以选择清除现场数据以便后续运行。

## 8. 安全考虑

### 8.1 调试访问控制

调试功能在量产车辆中需要严格控制，防止未授权的调试访问导致安全风险。摇光SoC实现多层次的调试访问控制机制。

**调试使能位**：芯片上电后，调试功能默认禁用。调试使能位存储在OTP（One-Time Programmable）存储器中，出厂时根据产品配置设置。调试使能位使能后，可以通过调试密钥再次禁用，但禁用后无法重新使能。

**安全域限制**：调试访问受安全域机制限制。在安全域边界，调试访问需要进行认证，认证失败则访问被拒绝。安全域配置确保非安全调试器无法访问安全域的敏感信息。

**访问权限分级**：调试操作按敏感程度分为多个级别，不同权限级别的调试器可执行的操作不同。访问权限在DAP中通过配置寄存器设置，需要有效的访问密钥才能修改。

### 8.2 调试信息安全

调试过程中传输的数据（寄存器值、内存内容、跟踪数据）可能包含敏感信息，需要保护其机密性和完整性。

**数据加密**：从TPIU输出的跟踪数据支持AES-128加密，加密密钥存储在安全密钥寄存器中。加密跟踪数据需要匹配的密钥才能解密，防止通过跟踪端口窃取敏感信息。

**数据完整性**：跟踪数据支持HMAC-SHA256完整性校验，校验值附加在每个跟踪数据包末尾。接收方验证校验值以检测数据篡改或传输错误。

**安全调试接口**：SWD接口支持安全调试协议，调试器需要经过认证才能执行调试操作。认证过程采用challenge-response方式，防止重放攻击。

### 8.3 功能安全考量

调试功能的实现需要符合ISO 26262 ASIL-D的要求，特别是调试功能本身不应引入安全风险。

**调试功能的故障模式**：可能的故障包括调试状态失控（无法暂停）、调试数据错误（误报断点）、调试访问冲突（死锁）。每种故障模式需要评估其对系统安全的影响。

**安全机制**：调试系统实现以下安全机制——看门狗定时器确保调试状态机不会卡死；冗余比较器检测调试状态计算的正确性；超时机制防止调试访问无限等待。

**安全验证**：调试功能需要通过故障注入测试验证安全机制的有效性。测试场景包括：注入单粒子翻转错误到调试寄存器、强制调试状态机进入异常状态、触发调试相关的硬件错误中断。

## 9. 接口信号定义

### 9.1 JTAG/SWD接口信号

| Signal | Direction | Description |
|--------|-----------|-------------|
| TCK/SWCLK | Input | 测试时钟/串行线时钟 |
| TMS/SWDIO | Bidirectional | 测试模式选择/串行线数据 |
| TDI | Input | 测试数据输入 |
| TDO | Output | 测试数据输出 |
| TRST | Input | 测试复位（低有效，可选） |

### 9.2 跟踪接口信号

| Signal | Direction | Description |
|--------|-----------|-------------|
| TRACE_CLK | Output | 跟踪数据时钟 |
| TRACE_D[31:0] | Output | 跟踪数据（8/16/32位模式） |
| TRACE_VALID | Output | 跟踪数据有效指示 |
| TRACE_SYNC | Output | 同步标志 |

### 9.3 内部调试接口信号

| Signal | Source | Destination | Description |
|--------|--------|-------------|-------------|
| DBGPWRDOWN | DAP | All | 调试电源控制 |
| DBGRESTORE | DAP | CPU | 调试恢复请求 |
| DBGACK | CPU | DAP | 调试响应确认 |
| EDBGREQ | External | DAP | 外部调试请求 |
| EDBGACK | DAP | External | 外部调试响应 |

## 10. 寄存器定义

### 10.1 DAP寄存器映射

| Offset | Name | Access | Description |
|--------|------|--------|-------------|
| 0x00 | DPIDR | RO | DP标识寄存器 |
| 0x04 | CTRL/STAT | RW | 控制/状态寄存器 |
| 0x0C | SELECT | RW | AP选择寄存器 |
| 0x10 | RDBUFF | RO | 读缓冲寄存器 |
| 0xFC | TARGETID | RO | 目标芯片ID |
| 0xF8 | DLPIDR | RO | 设计/层级标识 |

### 10.2 调试控制寄存器

| Field | Bits | R/W | Description |
|-------|------|-----|-------------|
| DBGEN | [0] | RW | 调试使能 |
| NIDEN | [1] | RW | 非侵入式调试使能 |
| SPIDEN | [2] | RW | 安全调试使能 |
| SPNIDEN | [3] | RW | 安全非侵入式调试使能 |
| DBGRSTREQ | [4] | WO | 系统复位请求 |
| DBGRSTACK | [5] | RO | 复位确认 |

## 11. 实现指标

### 11.1 性能指标

| Metric | Value | Unit |
|--------|-------|------|
| DAP访问延迟 | <20 | cycles |
| ETM跟踪带宽 | 4 | GB/s |
| TPIU输出带宽 | 8 | Gbps |
| 跟踪缓冲区大小 | 8 | MB |
| 硬件断点数量 | 4 | per CPU |
| 硬件观察点数量 | 4 | per CPU |
| 性能计数器数量 | 32 | total |

### 11.2 面积指标

| Component | Area | Unit |
|-----------|------|------|
| DAP | 0.05 | mm² |
| TPIU | 0.03 | mm² |
| ETM per core | 0.10 | mm² |
| ITM | 0.02 | mm² |
| STM | 0.04 | mm² |
| Trace Buffer | 0.50 | mm² |
| Debug Matrix | 0.08 | mm² |
| **Total** | **~0.9** | **mm²** |

### 11.3 功耗指标

| Component | Dynamic | Static | Unit |
|-----------|---------|--------|------|
| DAP | 0.5 | 0.1 | mW |
| TPIU | 2.0 | 0.2 | mW |
| ETM per core | 3.0 | 0.3 | mW |
| Trace Buffer | 5.0 | 1.0 | mW |
| **Total** | **~22** | **~2** | **mW** |

## 12. 验证要求

### 12.1 功能验证

调试模块的验证采用分层验证策略。模块级验证覆盖所有调试功能的正确性，包括：JTAG/SWD协议时序、调试寄存器读写、跟踪数据生成和路由、断点/观察点触发逻辑。子系统级验证覆盖调试模块与CPU核、加速器和总线的交互，包括：断点对CPU执行的影响、跟踪数据与CPU状态的一致性、DAP访问的正确路由。系统级验证在完整的SoC环境中进行，覆盖端到端的调试流程。

### 12.2 覆盖率要求

代码覆盖率目标：语句覆盖率100%，分支覆盖率100%，条件覆盖率100%，路径覆盖率95%。功能覆盖率覆盖所有调试场景，包括正常调试流程和异常场景（超时、错误、冲突）。

### 12.3 性能验证

调试系统的性能验证包括：跟踪带宽测试（验证峰值带宽达到设计指标）、延迟测试（验证访问延迟在允许范围内）、长时间稳定性测试（连续运行72小时无错误）。

## Revision History

| Version | Date | Author | Changes |
|---------|------|--------|---------|
| 1.0 | 2026-01-18 | YaoGuang Arch | Initial release |

## References

1. ARM CoreSight Architecture Specification (IHI0029)
2. ARM Debug Interface Architecture Specification (IHI0031)
3. IEEE 1149.1-2013 Standard Test Access Port and Boundary-Scan Architecture
4. ARMv8-A Architecture Reference Manual
5. ISO 26262:2018 Road vehicles - Functional safety
