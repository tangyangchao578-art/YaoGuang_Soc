# Display 子系统架构规格文档

**文档版本**: v1.0  
**创建日期**: 2026-01-18  
**状态**: **已评审通过**  
**评审日期**: 2026-01-18  
**模块名称**: Display Subsystem

---

## 1. 概述

### 1.1 文档目的

本文档定义了 YaoGuang SoC 芯片 Display 子系统的微架构规格，涵盖显示接口、显示引擎、帧缓冲接口、色彩处理流水线和功耗预算等关键设计要素。本规格文档作为后续 RTL 开发、验证和后端实现的基准文档。

### 1.2 模块定位

Display 子系统是 YaoGuang SoC 的重要输出外设，负责将芯片内部的图形数据转换为标准显示协议信号，驱动外部显示设备。该子系统连接 NoC 总线，接收来自 CPU、GPU 和 NPU 的图形渲染结果，支持多显示输出场景，满足车载娱乐系统、仪表盘显示和高级驾驶辅助系统（ADAS）的显示需求。

### 1.3 设计目标

本设计旨在实现以下核心目标：第一，支持业界主流显示接口标准，包括 HDMI 2.1、DisplayPort 1.4a 和 MIPI DSI-2，确保与市场上绝大多数显示设备的兼容性；第二，提供足够的带宽和分辨率支持，满足高分辨率、高刷新率显示场景的需求；第三，实现高效的色彩处理流水线，支持 HDR 和宽色域显示；第四，在满足性能要求的前提下，优化功耗表现，适应车规级应用的功耗约束。

---

## 2. 系统架构

### 2.1 整体架构

Display 子系统采用模块化架构设计，主要由以下功能模块组成：显示引擎（Display Engine）作为核心调度模块，负责协调各子模块的工作时序；帧缓冲读取器（Framebuffer Reader）负责从系统内存中读取像素数据；色彩处理器（Color Processing）执行色彩空间转换、HDR 映射和画质增强等处理；协议发送器模块包括 HDMI 发送器、DisplayPort 发送器和 MIPI DSI 发送器，分别对应三种显示输出接口。各模块之间通过内部专用总线互联，由显示引擎统一调度。

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           Display Subsystem                              │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  ┌─────────────┐    ┌──────────────────┐    ┌──────────────────────┐   │
│  │   NoC       │───▶│  Display Engine  │───▶│  HDMI 2.1 TX         │   │
│  │  Interface  │    │  (Timing &       │    │  (TMDS Encoder)       │   │
│  │  (AXI4)     │    │   Coordination)  │    └──────────────────────┘   │
│  └─────────────┘    │                  │                               │
│                     │                  │    ┌──────────────────────┐   │
│  ┌─────────────┐    │                  ├───▶│  DisplayPort 1.4a TX │   │
│  │ Framebuffer │───▶│  Color Processing │    │  (8b/10b, FEC)       │   │
│  │   Reader    │    │  Pipeline         │    └──────────────────────┘   │
│  └─────────────┘    │                  │                               │
│                     │                  │    ┌──────────────────────┐   │
│  ┌─────────────┐    │                  ├───▶│  MIPI DSI-2 TX       │   │
│  │   Memory    │    │                  │    │  (PHY, Packetizer)   │   │
│  │   Controller│◀───│                  │    └──────────────────────┘   │
│  └─────────────┘    └──────────────────┘                               │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 2.2 模块功能划分

**显示引擎（Display Engine）** 是整个子系统的控制核心，主要职责包括：生成显示时序信号（HSYNC、VSYNC、DE）；协调帧缓冲读取、色彩处理和协议发送的工作节奏；管理多个显示输出通道的同步；处理显示模式的切换和分辨率变更；实现帧缓冲的 ping-pong 双缓冲机制以避免画面撕裂。

**帧缓冲读取器（Framebuffer Reader）** 负责从系统内存中读取显示像素数据，主要功能包括：通过 AXI4 主接口访问系统内存中的帧缓冲数据；支持多种像素格式（RGB888、RGB565、BGR565、YUV422、YUV420 等）；实现高效的数据预取和缓存机制以最大化总线带宽利用率；支持行缓存和像素重排序以适应不同显示接口的数据格式要求。

**色彩处理流水线（Color Processing Pipeline）** 提供专业的图像后处理能力，主要功能包括：色彩空间转换（RGB ↔ YUV 多种格式之间转换）；HDR 色调映射（HDR10、Dolby Vision 格式支持）；宽色域映射（BT.2020 ↔ BT.709 色彩空间映射）；伽马校正（支持 2.2、HLG、PQ 伽马曲线）；动态对比度增强和自适应背光调节；降噪和边缘增强等画质优化功能。

**协议发送器模块** 分别实现三种显示接口的物理层和数据链路层协议：HDMI 2.1 发送器支持 TMDS 编码、最大 48Gbps 带宽和动态 HDR 元数据插入；DisplayPort 1.4a 发送器支持 8b/10b 编码、显示流压缩（DSC）和前向纠错（FEC）；MIPI DSI-2 发送器支持高速和低功耗模式切换、命令模式和视频模式操作。

---

## 3. 显示接口规格

### 3.1 HDMI 2.1 接口

HDMI 2.1 接口是消费电子领域最广泛使用的显示接口标准，本设计实现完整的 HDMI 2.1 规范特性。在电气特性方面，采用 TMDS（Transition Minimized Differential Signaling）差分信号传输，共使用 4 条数据通道（3 条数据通道 + 1 条时钟通道），每条通道支持最高 12Gbps 传输速率，聚合带宽达到 48Gbps。在分辨率支持方面，HDMI 2.1 接口支持的最大分辨率为 7680×4320（8K UHD），刷新率支持 60Hz（8K@60Hz）或 120Hz（8K@120Hz DSC 压缩）；对于 4K 分辨率（3840×2160），支持最高 120Hz 刷新率或 240Hz（4K@240Hz DSC 压缩）。色彩深度支持方面，HDMI 2.1 接口支持 8bit、10bit、12bit 色深，色域范围支持 BT.709、BT.2020、DCI-P3。在特性支持方面，动态 HDR（Dynamic HDR）支持逐帧元数据插入；可变刷新率（VRR）支持 48Hz-240Hz 范围内的自适应刷新；自动低延迟模式（ALLM）用于游戏场景的延迟优化；增强型音频回传通道（eARC）支持高质量音频回传。

```
HDMI 2.1 接口信号定义：
┌─────────────────────────────────────────────────────────────────┐
│  HDMI Connector Pins                                             │
├─────────┬───────────────────────────────────────────────────────┤
│  Pin 1  │  TMDS Data2+  (Channel 2 Positive)                    │
│  Pin 2  │  TMDS Data2-  (Channel 2 Negative)                    │
│  Pin 3  │  TMDS Data2 Shield                                    │
│  Pin 4  │  TMDS Data1+  (Channel 1 Positive)                    │
│  Pin 5  │  TMDS Data1-  (Channel 1 Negative)                    │
│  Pin 6  │  TMDS Data1 Shield                                    │
│  Pin 7  │  TMDS Data0+  (Channel 0 Positive)                    │
│  Pin 8  │  TMDS Data0-  (Channel 0 Negative)                    │
│  Pin 9  │  TMDS Data0 Shield                                    │
│  Pin 10 │  TMDS Clock+  (Clock Channel Positive)                │
│  Pin 11 │  TMDS Clock-  (Clock Channel Negative)                │
│  Pin 12 │  TMDS Clock Shield                                    │
│  Pin 13 │  CEC (Consumer Electronics Control)                   │
│  Pin 14 │  Utility / HEAC+ (HDMI Ethernet / Audio Return)       │
│  Pin 15 │  SCL (I2C Serial Clock for EDID)                      │
│  Pin 16 │  SDA (I2C Serial Data for EDID)                       │
│  Pin 17 │  DDC/CEC Ground                                       │
│  Pin 18 │  +5V Power (max 50mA)                                 │
│  Pin 19 │  Hot Plug Detect                                      │
└─────────┴───────────────────────────────────────────────────────┘
```

### 3.2 DisplayPort 1.4a 接口

DisplayPort 1.4a 接口是 PC 和专业显示领域的主流标准，本设计实现其核心特性。在物理层方面，采用 AC 耦合差分信号传输，主通道数量为 4 条，每条通道支持 8.1Gbps 有效数据速率（10Gbps 原始速率经 8b/10b 编码后），聚合带宽达到 32.4Gbps。在分辨率支持方面，DisplayPort 1.4a 接口支持的最大原生分辨率为 7680×4320@30Hz；通过显示流压缩（DSC）技术支持 8K@60Hz 或 4K@120Hz 传输；多流传输（MST）模式支持单接口连接多台显示设备。在特性支持方面，DSC（Display Stream Compression）压缩比最高可达 3:1，视觉无损压缩；前向纠错（FEC）提升高速传输的可靠性；自适应同步（Adaptive Sync）支持可变刷新率；HDR10 和 Dolby Vision 元数据包传输支持。

```
DisplayPort 1.4a 接口信号定义：
┌─────────────────────────────────────────────────────────────────┐
│  DisplayPort Connector Pins (Standard Full Size)                │
├─────────┬───────────────────────────────────────────────────────┤
│  Pin 1  │  Lane 0- (Main Link Channel 0 Negative)              │
│  Pin 2  │  Lane 0+ (Main Link Channel 0 Positive)              │
│  Pin 3  │  Lane 1- (Main Link Channel 1 Negative)              │
│  Pin 4  │  Lane 1+ (Main Link Channel 1 Positive)              │
│  Pin 5  │  Lane 2- (Main Link Channel 2 Negative)              │
│  Pin 6  │  Lane 2+ (Main Link Channel 2 Positive)              │
│  Pin 7  │  Lane 3- (Main Link Channel 3 Negative)              │
│  Pin 8  │  Lane 3+ (Main Link Channel 3 Positive)              │
│  Pin 9  │  GND (Ground)                                        │
│  Pin 10 │  Hot Plug Detect                                     │
│  Pin 11 │  GND (Ground)                                        │
│  Pin 12 │  Lane 3+ (AUX CH Positive for DP 1.4a)              │
│  Pin 13 │  Lane 3- (AUX CH Negative for DP 1.4a)              │
│  Pin 14 │  GND (Ground)                                        │
│  Pin 15 │  AUX CH+ (Auxiliary Channel Positive)               │
│  Pin 16 │  AUX CH- (Auxiliary Channel Negative)               │
│  Pin 17 │  GND (Ground)                                        │
│  Pin 18 │  3.3V Power                                          │
│  Pin 19 │  Return (Power Ground)                               │
│  Pin 20 │  DP_PWR (Power Output, 3.3V, max 500mA)             │
└─────────┴───────────────────────────────────────────────────────┘
```

### 3.3 MIPI DSI-2 接口

MIPI DSI-2（Display Serial Interface 2）是移动设备和平板电脑广泛采用的显示接口标准，本设计实现 DSI-2 规范的核心特性。在物理层方面，采用 MIPI D-PHY v1.2 或 C-PHY v1.2 物理层标准；数据通道配置为 1-4 条数据通道（Data Lane）加 1 条时钟通道（Clock Lane）；高速模式传输速率每通道最高 4.5Gbps（D-PHY）或 9.5Gbps per triad（C-PHY）。在分辨率支持方面，MIPI DSI-2 接口支持的最大分辨率取决于通道数量和刷新率：单通道配置支持 1920×1080@60Hz；四通道配置支持 3840×2160@60Hz 或 2560×1440@120Hz。在工作模式方面，视频模式（Video Mode）支持实时像素传输，适合动态内容显示；命令模式（Command Mode）支持帧缓冲存储和按需刷新，适合静态内容显示的低功耗应用场景。

```
MIPI DSI-2 接口信号定义（4通道 D-PHY 配置）：
┌─────────────────────────────────────────────────────────────────┐
│  MIPI DSI-2 Connector Pins                                      │
├─────────┬───────────────────────────────────────────────────────┤
│  CLK+   │  Clock Lane Positive (D-PHY)                          │
│  CLK-   │  Clock Lane Negative (D-PHY)                          │
│  DATA0+ │  Data Lane 0 Positive                                 │
│  DATA0- │  Data Lane 0 Negative                                 │
│  DATA1+ │  Data Lane 1 Positive                                 │
│  DATA1- │  Data Lane 1 Negative                                 │
│  DATA2+ │  Data Lane 2 Positive                                 │
│  DATA2- │  Data Lane 2 Negative                                 │
│  DATA3+ │  Data Lane 3 Positive                                 │
│  DATA3- │  Data Lane 3 Negative                                 │
│  GND    │  Ground                                               │
│  VDD    │  Power Supply (1.8V or 3.3V)                          │
└─────────┴───────────────────────────────────────────────────────┘
```

---

## 4. 最大分辨率与刷新率

### 4.1 分辨率支持矩阵

Display 子系统支持多种分辨率和刷新率组合，不同接口的最大能力如下表所示。该矩阵基于各接口的理论带宽上限计算得出，实际应用中可能受到系统内存带宽和处理器渲染能力的限制。

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                         显示分辨率与刷新率支持矩阵                                    │
├───────────────┬─────────────────────────────────────────────────────────────────────┤
│               │                          接口类型                                     │
│    分辨率     ├──────────────────┬────────────────────┬─────────────────────────────┤
│               │    HDMI 2.1      │   DisplayPort 1.4a │        MIPI DSI-2           │
│               │   (48Gbps)       │    (32.4Gbps)      │    (4 Lane D-PHY, 18Gbps)   │
├───────────────┼──────────────────┼────────────────────┼─────────────────────────────┤
│ 7680×4320    │ @30Hz Native     │ @30Hz Native       │ 不支持                      │
│ (8K UHD)      │ @60Hz DSC        │ @60Hz DSC          │                             │
├───────────────┼──────────────────┼────────────────────┼─────────────────────────────┤
│ 5120×2880    │ @60Hz Native     │ @60Hz Native       │ 不支持                      │
│ (5K)          │ @120Hz DSC       │ @120Hz DSC         │                             │
├───────────────┼──────────────────┼────────────────────┼─────────────────────────────┤
│ 3840×2160    │ @60Hz Native     │ @60Hz Native       │ @60Hz (4 Lane)              │
│ (4K UHD)      │ @120Hz Native    │ @120Hz DSC         │ @120Hz (4 Lane, DSC)        │
│               │ @240Hz DSC       │                    │                             │
├───────────────┼──────────────────┼────────────────────┼─────────────────────────────┤
│ 2560×1440    │ @165Hz Native    │ @165Hz Native      │ @120Hz (4 Lane)             │
│ (2.5K/QHD)    │ @240Hz Native    │ @240Hz Native      │ @144Hz (4 Lane)             │
├───────────────┼──────────────────┼────────────────────┼─────────────────────────────┤
│ 1920×1080    │ @240Hz Native    │ @240Hz Native      │ @144Hz (4 Lane)             │
│ (FHD)         │ @360Hz Native    │ @360Hz Native      │ @240Hz (4 Lane)             │
├───────────────┼──────────────────┼────────────────────┼─────────────────────────────┤
│ 1280×720     │ @360Hz Native    │ @360Hz Native      │ @240Hz (4 Lane)             │
│ (HD)          │                  │                    │                             │
└───────────────┴──────────────────┴────────────────────┴─────────────────────────────┘
```

### 4.2 典型应用场景分辨率

针对车载应用场景，本设计定义了以下典型分辨率配置：

**仪表盘显示（Instrument Cluster）**：分辨率范围 1920×720 至 2560×1080，典型刷新率 60Hz，采用单接口输出，支持 24bit 色深，主要显示车辆状态、导航信息和娱乐内容。

**中控娱乐显示（Infotainment Display）**：分辨率范围 1920×1080 至 2560×1600，典型刷新率 60Hz，支持多点触控交互，采用 HDMI 或 DisplayPort 接口输出，支持 HDR10 色彩增强。

**副驾娱乐显示（Passenger Display）**：分辨率范围 1920×1080 至 3840×2160，典型刷新率 60Hz，支持独立内容播放，采用 HDMI 或 MIPI DSI-2 接口输出。

**后座娱乐显示（Rear Seat Display）**：分辨率范围 1280×720 至 1920×1080，典型刷新率 60Hz，采用 MIPI DSI-2 接口输出多路显示。

**电子后视镜（e-Mirror）**：分辨率范围 1280×720 至 1920×1080，典型刷新率 60Hz-120Hz，支持低延迟实时视频传输，对响应时间有严格要求。

---

## 5. 显示引擎架构

### 5.1 显示引擎功能概述

显示引擎是 Display 子系统的核心控制模块，负责生成显示时序、协调各子模块工作、管理帧缓冲和实现显示输出切换。显示引擎采用状态机控制方式，根据配置的显示参数生成精确的像素时钟和时序控制信号，驱动整个显示流水线的运作。

### 5.2 显示时序生成

显示引擎内置时序生成器，支持标准的 VESA 显示时序规范。时序参数可通过寄存器配置，适配不同的分辨率和刷新率需求。典型的 1920×1080@60Hz 时序参数配置如下：像素时钟频率为 148.5MHz；水平方向参数包括有效像素 1920、前沿 88、同步脉冲 44、后沿 148，总计 2200 像素每行；垂直方向参数包括有效像素 1080、前沿 4、同步脉冲 5、后沿 36，总计 1125 行每帧。

```
显示时序信号时序图：
┌──────────────────────────────────────────────────────────────────────────────┐
│                                                                              │
│  Horizontal Timing (Line):                                                   │
│  ────────────────────────────────────────────────────────────────────       │
│  ┌────────────────────┬──────────┬─────────────┬─────────────┐               │
│  │   Active Video     │  HFP     │   HSYNC     │    HBP      │               │
│  │      (1920)        │   (88)   │    (44)     │    (148)    │               │
│  └────────────────────┴──────────┴─────────────┴─────────────┘               │
│  ◄─────────────────────────────────────────────────────────────────►        │
│                              Total Line: 2200 pixels                         │
│                                                                              │
│  Vertical Timing (Frame):                                                    │
│  ────────────────────────────────────────────────────────────────────       │
│  ┌────────────────────┬──────────┬─────────────┬─────────────┐               │
│  │   Active Video     │  VFP     │   VSYNC     │    VBP      │               │
│  │      (1080)        │   (4)    │    (5)      │    (36)     │               │
│  └────────────────────┴──────────┴─────────────┴─────────────┘               │
│  ◄─────────────────────────────────────────────────────────────────►        │
│                             Total Frame: 1125 lines                          │
│                                                                              │
│  Data Enable (DE)  ────┐                                           ┌───      │
│                        └───────────────────────────────────────────┘          │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

### 5.3 帧缓冲管理

显示引擎实现 ping-pong 双缓冲机制以支持流畅的显示输出和避免画面撕裂。前端缓冲区（Front Buffer）供显示引擎读取并输出到显示设备；后端缓冲区（Back Buffer）供图形渲染器写入新的帧数据。当一帧传输完成后，两个缓冲区角色互换，实现无缝切换。显示引擎还支持垂直同步（V-Sync）信号与 NoC 总线系统同步，确保帧缓冲更新的原子性。

帧缓冲地址管理通过寄存器配置，支持以下参数设置：帧缓冲起始地址（32byte 对齐）、帧缓冲行跨度（Stride，64byte 对齐）、帧缓冲高度、像素格式选择。显示引擎在每帧开始时读取帧缓冲地址寄存器，在帧传输过程中保持地址不变，确保一帧数据的完整性。

### 5.4 多通道协调

显示引擎支持 同时驱动最多3 个显示输出通道（HDMI、DisplayPort、MIPI DSI-2 各一个），并实现以下协调功能：多通道同步启动，确保多屏显示时画面内容一致；独立分辨率配置，允许各通道输出不同分辨率和刷新率；帧率转换，当输入帧率与输出帧率不匹配时，通过动态缓冲实现帧率上变换或下变换；画面拼接，支持将一幅高分辨率画面分割到多个显示设备上输出。

### 5.5 异常处理

显示引擎实现完善的异常检测和处理机制。帧缓冲欠载检测在检测到帧缓冲读取速度跟不上显示扫描速度时触发中断或错误标志；内存访问超时检测防止长时间占用总线导致系统死锁；CRC 校验对传输的关键数据进行校验，检测位翻转错误；看门狗定时器在显示引擎停止响应时自动复位模块。

---

## 6. 帧缓冲接口

### 6.1 AXI4 主接口规格

帧缓冲读取器通过 AXI4 主接口访问系统内存，接口规格如下：数据宽度为 64bit；支持突发传输类型为 INCR（增量突发）和 FIXED（固定突发）；最大突发长度为 16；支持Outstanding 交易数为 8；地址映射为 32bit 物理地址空间（支持扩展到 64bit）。

```
AXI4 主接口信号定义：
┌─────────────────────────────────────────────────────────────────────────────┐
│  AXI4 Master Interface Signals                                              │
├────────────────┬───────────────────────────────────────────────────────────┤
│  Signal Name   │  Description                                               │
├────────────────┼───────────────────────────────────────────────────────────┤
│  m_axi_awid    │  Write Address ID                                          │
│  m_axi_awaddr  │  Write Address (32-bit)                                    │
│  m_axi_awlen   │  Write Burst Length (1-16)                                 │
│  m_axi_awsize  │  Write Burst Size (3'b110 = 64-bit)                        │
│  m_axi_awburst │  Write Burst Type (2'b01 = INCR)                           │
│  m_axi_awvalid │  Write Address Valid                                       │
│  m_AXI_awready │  Write Address Ready                                       │
│  m_axI_arid    │  Read Address ID                                           │
│  m_axI_araddr  │  Read Address (32-bit)                                     │
│  m_axI_arlen   │  Read Burst Length (1-16)                                  │
│  m_axI_arsize  │  Read Burst Size (3'b110 = 64-bit)                         │
│  m_axI_arburst │  Read Burst Type (2'b01 = INCR)                            │
│  m_axI_arvalid │  Read Address Valid                                        │
│  m_axI_arready │  Read Address Ready                                        │
│  m_axI_rid     │  Read Response ID                                          │
│  m_axI_rdata   │  Read Data (64-bit)                                        │
│  m_axI_rresp   │  Read Response (OKAY, EXOKAY, SLVERR, DECERR)              │
│  m_axI_rvalid  │  Read Valid                                                │
│  m_axI_rready  │  Read Ready                                                │
└────────────────┴───────────────────────────────────────────────────────────┘
```

### 6.2 像素格式支持

帧缓冲读取器支持多种像素格式的解析和转换：

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              支持的像素格式                                          │
├───────────┬──────────────────────────────────────────────────────────────────────────┤
│  格式名称  │  说明                                                                    │
├───────────┼──────────────────────────────────────────────────────────────────────────┤
│  RGB888   │  24-bit，每像素 3 字节（8-bit R, 8-bit G, 8-bit B）                     │
│  RGB565   │  16-bit，每像素 2 字节（5-bit R, 6-bit G, 5-bit B）                     │
│  BGR565   │  16-bit，每像素 2 字节（5-bit B, 6-bit G, 5-bit R）                     │
│  RGBA8888 │  32-bit，每像素 4 字节（8-bit R, 8-bit G, 8-bit B, 8-bit A）            │
│  BGRA8888 │  32-bit，每像素 4 字节（8-bit B, 8-bit G, 8-bit R, 8-bit A）            │
│  YUV422   │  16-bit，每像素 2 字节（Y:U:V 按 4:2:2 采样）                           │
│  YUV420   │  12-bit，每像素 1.5 字节（Y:U:V 按 4:2:0 采样）                         │
│  YUV444   │  24-bit，每像素 3 字节（Y:U:V 按 4:4:4 采样）                           │
└───────────┴──────────────────────────────────────────────────────────────────────────┘
```

### 6.3 带宽需求分析

以 1920×1080@60Hz、RGB888 格式为例，计算帧缓冲读取的带宽需求：像素时钟为 148.5MHz；每像素 3 字节；每帧数据量为 1920×1080×3 = 6.22MB；每秒数据量为 6.22MB×60 = 373MB/s；内存接口带宽为 64bit（8字节）×核心频率，假设内存频率为 800MHz，实际内存带宽需求约为 500MB/s（考虑效率开销）。

对于 4K@60Hz 场景，带宽需求约为 4 倍，即约 1.5GB/s。帧缓冲读取器通过以下方式优化带宽利用率：突发传输最大化，减少总线仲裁开销；行缓存预取，提前读取下一行数据；压缩格式支持（ASTC 等）减少传输数据量；多通道 DDR 内存控制器聚合带宽。

---

## 7. 色彩处理流水线

### 7.1 流水线架构

色彩处理流水线采用多级流水线结构，每级完成特定的图像处理功能，各流水线级之间使用 FIFO 进行数据缓冲，实现完全流水的处理模式。流水线支持旁路（Bypass）模式，允许在不需要特定处理功能时跳过该级，减少处理延迟和功耗。

```
色彩处理流水线架构：
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                     │
│  Input Pixel     ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐    │
│  Stream   ──────▶│  Color   │───▶│   HDR    │───▶│   Gamma  │───▶│  Dither  │───▶│
│  (RGB/YCbCr)     │  Space   │    │  Mapping │    │Correction│    │  Engine  │    │
│                  │Converter │    │          │    │          │    │          │    │
│                  └──────────┘    └──────────┘    └──────────┘    └──────────┘    │
│                       │              │              │              │              │
│                       ▼              ▼              ▼              ▼              │
│                  ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐    │
│                  │  Degamma │    │  Tone    │    │  Color   │    │   Peak   │    │
│                  │(Optional)│    │Mapping   │    │Gamut Map │    │  Finder  │    │
│                  └──────────┘    └──────────┘    └──────────┘    └──────────┘    │
│                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

### 7.2 色彩空间转换

色彩空间转换级实现 RGB 与 YCbCr 之间的双向转换，支持以下标准：ITU-R BT.601（标清广播标准）、ITU-R BT.709（高清广播标准）、ITU-R BT.2020（超高清广播标准）、JPEG/YCbCr（图像压缩标准）。转换系数通过寄存器配置，支持自定义系数以适应特殊应用场景。

**RGB 到 YCbCr 转换公式（BT.709）**：
Y = 0.2126×R + 0.7152×G + 0.0722×B
Cb = -0.1146×R - 0.3854×G + 0.5000×B + 128
Cr = 0.5000×R - 0.4542×G - 0.0458×B + 128

**YCbCr 到 RGB 转换公式（BT.709）**：
R = Y + 1.5748×(Cr - 128)
G = Y - 0.1873×(Cb - 128) - 0.4681×(Cr - 128)
B = Y + 1.8556×(Cb - 128)

### 7.3 HDR 处理

HDR 处理级支持 HDR10 和 HLG 两种主流 HDR 格式的元数据解析和色调映射。输入端支持 PQ（Perceptual Quantizer）和 HLG（Hybrid Log-Gamma）两种伽马曲线；输出端支持 BT.2020 宽色域和 10bit/12bit 色深；色调映射采用可配置的曲线形状，支持动态范围扩展和收缩以适应显示设备能力。

HDR 元数据通过专用寄存器组配置，包括：最大内容光亮度（MaxCLL）、最大帧平均光亮度（MaxFALL）、色彩体积信息。元数据可动态更新，实现逐帧 HDR 调整。

### 7.4 伽马校正

伽马校正级实现输入像素值到输出线性光空间的转换（Degamma）和反向转换（Gamma），支持多种伽马曲线标准：BT.1886（2.4 伽马曲线）、sRGB（2.2 伽马曲线，近似）、PQ（ST 2084，最高 10000nit）、HLG（ARIB STD-B67，最高 1000nit）。伽马校正采用分段线性逼近或查找表（LUT）实现，精度为 12-bit 输入对应 12-bit 输出。

### 7.5 色彩增强

色彩增强级包含以下可选处理功能：动态对比度增强（DCE）通过分析局部图像统计信息自适应调整对比度；自适应饱和度控制（ASC）根据亮度水平调整色彩饱和度；肤色保护（Skin Tone Protection）防止色彩增强导致肤色失真；蓝色噪声抖动（Blue Noise Dithering）在低色深输出时提供视觉平滑效果。

---

## 8. 功耗预算

### 8.1 功耗模型

Display 子系统的功耗主要由以下几部分组成：动态功耗包括像素数据处理逻辑的开关功耗和时钟树功耗；存储器功耗包括帧缓冲读取器内部缓存和寄存器的读写功耗；接口功耗包括 HDMI、DisplayPort 和 MIPI DSI-2 输出驱动器的功耗；静态功耗主要是漏电流功耗。

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                           Display 子系统功耗分解                                      │
├─────────────────────┬───────────────────────────────────────────────────────────────┤
│     模块            │  典型功耗（mW）                                                 │
│                     ├──────────────────────┬─────────────────────────────────────────┤
│                     │  1080p@60Hz          │  4K@60Hz                                 │
├─────────────────────┼──────────────────────┼─────────────────────────────────────────┤
│  显示引擎           │  15-20               │  25-35                                   │
├─────────────────────┼──────────────────────┼─────────────────────────────────────────┤
│  帧缓冲读取器       │  25-35               │  60-80                                   │
├─────────────────────┼──────────────────────┼─────────────────────────────────────────┤
│  色彩处理流水线     │  30-45               │  80-120                                  │
├─────────────────────┼──────────────────────┼─────────────────────────────────────────┤
│  HDMI 2.1 TX        │  80-120              │  150-200                                 │
├─────────────────────┼──────────────────────┼─────────────────────────────────────────┤
│  DisplayPort 1.4a TX│  70-100              │  130-180                                 │
├─────────────────────┼──────────────────────┼─────────────────────────────────────────┤
│  MIPI DSI-2 TX      │  40-60               │  100-140                                 │
├─────────────────────┼──────────────────────┼─────────────────────────────────────────┤
│  静态功耗           │  10-15               │  15-20                                   │
├─────────────────────┼──────────────────────┼─────────────────────────────────────────┤
│  总计（单通道）     │  270-395             │  560-775                                 │
├─────────────────────┼──────────────────────┼─────────────────────────────────────────┤
│  总计（三通道全开） │  350-500             │  750-1000                                │
└─────────────────────┴──────────────────────┴─────────────────────────────────────────┘
```

### 8.2 功耗优化策略

**时钟门控**：各模块在空闲状态时自动关闭时钟，减少动态功耗；帧缓冲读取器在行消隐期间关闭时钟；色彩处理流水线在旁路模式时跳过处理级时钟。

**电源门控**：未使用的输出接口通道完全关闭电源；内部缓存根据实际使用需求动态调整深度和供电。

**动态电压频率调节（DVFS）**：根据显示分辨率和帧率动态调整工作频率和电压；低分辨率、低帧率场景使用较低的时钟频率和电压以节省功耗；高负载场景自动提升频率以满足性能需求。

**自适应刷新**：在静态画面显示时降低刷新率，减少帧缓冲读取和接口传输的功耗；检测画面内容变化，只在画面更新时全速运行。

### 8.3 功耗状态定义

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              功耗状态定义                                             │
├───────────┬──────────────────────────────────────────────────────────────────────────┤
│  状态     │  说明                                                                    │
├───────────┼──────────────────────────────────────────────────────────────────────────┤
│  ACTIVE   │  正常运行状态，所有模块工作，功耗最高                                    │
│  IDLE     │  帧消隐期间，显示引擎等待，色彩处理流水线暂停                            │
│  STANDBY  │  显示输出暂停（无有效信号），各模块进入低功耗状态                        │
│  OFF      │  电源关闭状态（电源门控），最低功耗                                      │
└───────────┴──────────────────────────────────────────────────────────────────────────┘
```

---

## 9. 接口定义

### 9.1 系统级接口

**NoC 从接口（Slave）**：通过该接口接收来自 CPU/GPU 的配置和控制命令；地址空间为 4KB；支持 32bit 读写事务；支持字节、半字、字访问粒度。

**AXI4 主接口（Master）**：用于帧缓冲读取；数据宽度 64bit；支持突发传输，最大突发长度 16；支持Outstanding 交易数 8。

**时钟与复位**：系统时钟输入（pixel_clk）为显示引擎主时钟；复位信号为异步复位、同步释放；可选的外部显示时钟输入支持。

### 9.2 外部接口

**HDMI 接口**：TMDS 差分数据通道 3 对 + 时钟通道 1 对；CEC 单端控制信号；I2C EDID 接口信号；HPD 热插拔检测信号。

**DisplayPort 接口**：Main Link 差分通道 4 对；AUX CH 差分通道 1 对；HPD 热插拔检测信号；电源输出（3.3V，500mA max）。

**MIPI DSI-2 接口**：D-PHY 差分时钟通道 1 对 + 数据通道 1-4 对；或 C-PHY 三相编码通道 1-3 对；电源和地信号。

---

## 10. 寄存器定义

### 10.1 寄存器映射

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              Display 子系统寄存器映射                                │
├──────────────────────┬───────────┬──────────────────────────────────────────────────┤
│      地址偏移         │  大小     │  寄存器名称与功能                                 │
├──────────────────────┼───────────┼──────────────────────────────────────────────────┤
│  0x0000              │  32bit    │  DISPLAY_CTRL（显示控制寄存器）                   │
│  0x0004              │  32bit    │  DISPLAY_STATUS（显示状态寄存器）                 │
│  0x0008              │  32bit    │  TIMING_H_TOTAL（水平总像素数）                   │
│  0x000C              │  32bit    │  TIMING_H_ACTIVE（水平有效像素数）                │
│  0x0010              │  32bit    │  TIMING_H_SYNC_START（水平同步开始）              │
│  0x0014              │  32bit    │  TIMING_H_SYNC_END（水平同步结束）                │
│  0x0018              │  32bit    │  TIMING_V_TOTAL（垂直总行数）                     │
│  0x001C              │  32bit    │  TIMING_V_ACTIVE（垂直有效行数）                  │
│  0x0020              │  32bit    │  TIMING_V_SYNC_START（垂直同步开始）              │
│  0x0024              │  32bit    │  TIMING_V_SYNC_END（垂直同步结束）                │
│  0x0030              │  32bit    │  FB_ADDR_L（帧缓冲起始地址低 32 位）              │
│  0x0034              │  32bit    │  FB_ADDR_H（帧缓冲起始地址高 32 位）              │
│  0x0038              │  32bit    │  FB_STRIDE（帧缓冲行跨度）                        │
│  0x003C              │  32bit    │  FB_FORMAT（像素格式选择）                        │
│  0x0040              │  32bit    │  INT_STATUS（中断状态）                           │
│  0x0044              │  32bit    │  INT_MASK（中断屏蔽）                             │
│  0x0100              │  32bit    │  COLOR_SPACE（色彩空间配置）                      │
│  0x0104              │  32bit    │  GAMMA_LUT_ADDR（伽马 LUT 地址）                  │
│  0x0108              │  32bit    │  GAMMA_LUT_DATA（伽马 LUT 数据）                  │
│  0x0200              │  32bit    │  HDMI_CTRL（HDMI 控制）                           │
│  0x0300              │  32bit    │  DP_CTRL（DisplayPort 控制）                      │
│  0x0400              │  32bit    │  DSI_CTRL（MIPI DSI 控制）                        │
└──────────────────────┴───────────┴──────────────────────────────────────────────────┘
```

### 10.2 关键寄存器说明

**DISPLAY_CTRL（0x0000）**：
- bit[0]：DISPLAY_ENABLE，显示使能位
- bit[1]：VSYNC_POL，垂直同步极性（0=低有效，1=高有效）
- bit[2]：HSYNC_POL，水平同步极性（0=低有效，1=高有效）
- bit[3]：DE_POL，数据使能极性
- bit[4]：INTERLACED，隔行扫描模式使能
- bit[5]：OUTPUT_SEL，输出接口选择（00=HDMI，01=DP，10=DSI，11=全部）
- bit[31:16]：RESERVED，保留位

**DISPLAY_STATUS（0x0004）**：
- bit[0]：ACTIVE，显示是否处于活动状态
- bit[1]：FRAME_DONE，帧传输完成标志（写1清零）
- bit[2]：VSYNC_EDGE，垂直同步边沿检测标志
- bit[3]：FB_UNDERRUN，帧缓冲欠载错误标志
- bit[31:8]：RESERVED，保留位

**FB_FORMAT（0x003C）**：
- bit[3:0]：PIXEL_FORMAT，像素格式选择（0000=RGB888，0001=RGB565，0010=RGBA8888，0100=YUV422，0101=YUV420）
- bit[4]：ENDIANNESS，像素字节序（0=小端，1=大端）
- bit[5]：SWAP_RB，红蓝通道交换使能
- bit[7:6]：RESERVED，保留位

---

## 11. 设计约束

### 11.1 时序约束

**时钟域定义**：
- sys_clk：系统时钟，频率 100-200MHz，驱动寄存器配置逻辑
- pixel_clk：像素时钟，频率 25-600MHz（根据分辨率和刷新率），驱动显示数据通路
- axi_clk：AXI 总线时钟，与 NoC 频率匹配，典型 200MHz
- tx_clk：发送器时钟，HDMI/DP 为 pixel_clk，DSI 为 DDR 时钟

**时序目标**：
- 关键路径延迟 < 1 pixel_clk 周期（流水线设计）
- 建立时间裕度 > 20% 时钟周期
- 保持时间裕度 > 10% 时钟周期
- 复位到稳定状态时间 < 100 个时钟周期

### 11.2 面积约束

- 预估逻辑门数：约 150K-200K 标准单元（综合后）
- 预估 SRAM 需求：约 64KB（帧缓冲读取缓存）
- 预估宏单元：2 个 PLL（用于时钟生成），1 个 RTAX4S FPGA 原型适配

### 11.3 功耗约束

- 典型工作功耗：< 500mW（单通道 1080p@60Hz）
- 最大工作功耗：< 1000mW（三通道全开 4K@60Hz）
- 待机功耗：< 50mW
- 关闭功耗：< 10mW

---

## 12. 验证计划

### 12.1 模块级验证（DV）

- 显示引擎时序生成验证：覆盖所有标准分辨率模式
- 帧缓冲读取器功能验证：覆盖所有支持的像素格式
- 色彩处理流水线验证：覆盖所有色彩空间转换组合
- HDMI 发送器协议验证：符合 HDMI 2.1 规范测试向量
- DisplayPort 发送器协议验证：符合 DisplayPort 1.4a 规范测试向量
- MIPI DSI-2 发送器协议验证：符合 DSI-2 规范测试向量

### 12.2 系统级验证（CV）

- SoC 集成验证：多核 CPU + GPU 协同渲染显示验证
- Boot 流程验证：上电后显示初始化和首帧显示验证
- 性能验证：达到标称分辨率和刷新率目标
- 压力测试：长时间连续运行稳定性验证
- 异常恢复：欠载、超时等异常场景恢复验证

---

## 13. 参考文献

1. VESA DisplayPort Standard Version 1.4a
2. HDMI 2.1 Specification
3. MIPI Display Serial Interface (DSI) Specification Version 2.0
4. VESA Display Monitor Timing Standard Version 1.0, Revision 13
5. ITU-R BT.1886: Reference gamma for studio production
6. ITU-R BT.2020: Parameter values for ultra-high definition television
7. SMPTE ST 2084: High Dynamic Range Electro-Optical Transfer Function

---

**文档版本历史**：

| 版本 | 日期 | 作者 | 变更说明 |
|------|------|------|----------|
| v1.0 | 2026-01-18 | YaoGuang Arch Team | 初始版本 |
