# YaoGuang SoC Crypto 模块架构规格

## 1. 概述

### 1.1 模块定位
Crypto 模块是 YaoGuang 车规级 SoC 的安全计算引擎，提供硬件加速的加密/解密、哈希运算、密钥管理和真随机数生成功能。该模块作为系统安全基础设施的核心组件，支持安全启动、数据加密存储、网络安全传输等关键安全应用场景。

### 1.2 设计目标
本模块的设计参考了 ARM TrustZone CryptoCell-312 和 RISC-V Cryptography Extension 规范，结合车规级应用场景的需求进行适配。设计目标包括：提供符合 ISO 26262 ASIL-D 要求的硬件安全机制；支持主流对称加密、非对称加密和哈希算法；实现与主处理器的低延迟接口；满足车规级功耗和面积约束。

### 1.3 参考标准
本架构规格参考以下标准和规范：ARM TrustZone CryptoCell-312 技术参考手册；RISC-V Cryptography Extensions 规范 v1.0；NIST FIPS 180-4（SHA）、FIPS 197（AES）、FIPS 186-4（ECDSA）；中国国家密码算法标准 GM/T 0054-2018（SM2/SM3/SM4）；ISO 26262道路车辆功能安全标准；IEC 61508工业功能安全标准。

## 2. 系统架构

### 2.1 顶层架构
Crypto 模块采用分层架构设计，包含以下主要组件：顶层控制单元负责全局状态管理和接口仲裁；对称加密引擎提供 AES/SM4 硬件加速；哈希引擎提供 SHA/SM3 硬件加速；非对称加密引擎提供 RSA/ECC/SM2 运算；真随机数生成器提供高质量随机数；密钥管理单元负责密钥存储、派生和销毁。各组件通过内部总线互连，支持独立运行和并行操作。

```
┌─────────────────────────────────────────────────────────────────┐
│                      Crypto Top Module                           │
├─────────────────────────────────────────────────────────────────┤
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────┐   │
│  │  Control     │  │  APB/AXI     │  │  Interrupt           │   │
│  │  FSM         │  │  Interface   │  │  Controller          │   │
│  └──────┬───────┘  └──────┬───────┘  └──────────────────────┘   │
│         │                 │                                     │
│  ┌──────┴───────┬─────────┴─────────┬─────────────────────┐    │
│  │              │                   │                     │    │
│  ▼              ▼                   ▼                     ▼    │
│ ┌────────┐  ┌────────┐  ┌────────────────┐  ┌────────────┐   │
│ │  AES   │  │  SHA   │  │  RSA/ECC/SM2   │  │   TRNG     │   │
│ │ Engine │  │ Engine │  │    Engine      │  │   Engine   │   │
│ └────────┘  └────────┘  └────────────────┘  └────────────┘   │
│         │              │                   │                  │
│         └──────────────┼───────────────────┘                  │
│                        ▼                                      │
│              ┌─────────────────┐                              │
│              │ Key Management  │                              │
│              │     Unit        │                              │
│              └─────────────────┘                              │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 接口规格
Crypto 模块对外提供以下接口：APB 总线接口用于寄存器配置和控制；AXI4-Stream 接口用于大数据量传输；中断信号用于操作完成和错误通知；复位和时钟信号用于电源管理。接口时序遵循 AMBA 4 APB 和 AXI4 标准协议。

| 接口名称 | 协议 | 方向 | 描述 |
|---------|------|------|------|
| pclk | 时钟 | 输入 | APB 时钟 |
| presetn | 复位 | 输入 | APB 复位（低有效） |
| paddr | 地址 | 输入 | APB 地址 |
| pwdata | 数据 | 输入 | APB 写数据 |
| prdata | 数据 | 输出 | APB 读数据 |
| pwrite | 控制 | 输入 | APB 写使能 |
| psel | 选择 | 输入 | APB 选择 |
| penable | 使能 | 输入 | APB 使能 |
| axis_tvalid | 有效 | 输入/输出 | AXI Stream 有效 |
| axis_tready | 就绪 | 输入/输出 | AXI Stream 就绪 |
| axis_tdata | 数据 | 输入/输出 | AXI Stream 数据 |
| crypto_intr | 中断 | 输出 | 加密中断 |

## 3. 加密算法支持

### 3.1 对称加密算法

#### 3.1.1 AES 引擎
AES 引擎支持 AES-128、AES-192 和 AES-256 密钥长度，支持 CBC、CFB、CTR、ECB 和 GCM 五种工作模式。硬件实现采用迭代结构，每个时钟周期完成一轮 AES 运算。AES-256 在 200MHz 时钟下可实现 1.6 GB/s 的加密吞吐量，满足高速数据加密需求。

AES-GCM 模式支持认证加密，提供 128 位认证标签。引擎内部集成了 GHASH 运算单元，可与 AES-CTR 模式并行处理，实现认证加密的流水线操作。密钥扩展单元支持在线密钥扩展，无需软件干预即可完成密钥调度。

| 参数 | 规格 |
|------|------|
| 密钥长度 | 128/192/256 位 |
| 块大小 | 128 位 |
| 工作模式 | CBC/CFB/CTR/ECB/GCM |
| 加密吞吐量 | > 1.6 GB/s (AES-256, 200MHz) |
| 延迟 | 14/14/14 周期 (128/192/256) |

#### 3.1.2 SM4 引擎
SM4 算法是中国国家密码管理局发布的分组密码标准，用于无线局域网安全。SM4 引擎支持 128 位密钥和 128 位明文块，支持 CBC 和 CTR 工作模式。硬件实现采用 32 轮迭代结构，每个时钟周期完成一轮运算。

| 参数 | 规格 |
|------|------|
| 密钥长度 | 128 位 |
| 块大小 | 128 位 |
| 工作模式 | CBC/CTR |
| 加密吞吐量 | > 800 MB/s (200MHz) |
| 延迟 | 32 周期 |

### 3.2 哈希算法

#### 3.2.1 SHA-2 引擎
SHA-256 引擎支持 SHA-224、SHA-256、SHA-384 和 SHA-512 算法。引擎采用迭代压缩结构，每个时钟周期完成 32 位（SHA-256）或 64 位（SHA-512）的消息扩展和压缩运算。引擎支持消息长度预处理，可自动处理消息填充。

SHA-256 在 200MHz 时钟下实现 800 MB/s 的哈希吞吐量，支持实时数据完整性校验。引擎支持消息无关预处理，可在数据到达前完成初始化向量加载。

| 参数 | SHA-256 | SHA-384 | SHA-512 |
|------|---------|---------|---------|
| 摘要长度 | 256 位 | 384 位 | 512 位 |
| 消息块 | 512 位 | 1024 位 | 1024 位 |
| 吞吐量 | > 800 MB/s | > 1.2 GB/s | > 1.2 GB/s |
| 延迟/块 | 64 周期 | 80 周期 | 80 周期 |

#### 3.2.2 SHA-3 引擎
SHA-3 引擎支持 SHA3-224、SHA3-256、SHA3-384 和 SHA3-512 算法。引擎采用 Keccak-p 置换结构，实现 Keccak-f[1600] 状态转换。硬件优化包括：并行 sponge 操作、消息注入优化、状态寄存器流水线。

| 参数 | SHA3-256 | SHA3-384 | SHA3-512 |
|------|----------|----------|----------|
| 摘要长度 | 256 位 | 384 位 | 512 位 |
| 状态宽度 | 1600 位 | 1600 位 | 1600 位 |
| 吞吐量 | > 600 MB/s | > 700 MB/s | > 800 MB/s |

#### 3.2.3 SM3 引擎
SM3 算法是中国国家密码管理局发布的哈希算法标准，用于数字签名和消息认证。SM3 引擎生成 256 位摘要，采用 512 位消息块。引擎结构与 SHA-256 类似，在 200MHz 时钟下实现 800 MB/s 的吞吐量。

### 3.3 非对称加密算法

#### 3.3.1 RSA 引擎
RSA 引擎支持 1024、2048 和 4096 位密钥长度，支持 PKCS#1 v1.5 和 PSS 填充方案。硬件实现采用 Montgomery 乘法器和 Barrett 约减算法，支持快速的模幂运算。引擎支持 CRT 模式，可将模幂运算分解为两个较小规模的运算，提高运算效率。

RSA-2048 签名操作在 10ms 内完成（200MHz 时钟），满足实时签名验证需求。引擎支持密钥生成功能，可生成指定长度的 RSA 密钥对。

| 参数 | 规格 |
|------|------|
| 密钥长度 | 1024/2048/4096 位 |
| 签名速度 | < 10ms (RSA-2048) |
| 解密速度 | < 5ms (RSA-2048) |
| 填充方案 | PKCS#1 v1.5, PSS |

#### 3.3.2 ECC 引擎
ECC 引擎支持 NIST P-256、P-384 和 P-521 曲线，以及 secp256k1 曲线。硬件实现包括：仿射坐标到雅可比坐标转换、曲线点乘单元、Montgomery 乘法器、模逆运算单元。点乘运算采用固定基点窗口法优化，支持 128 位安全级别。

P-256 点乘运算在 0.5ms 内完成（200MHz 时钟），满足实时身份认证需求。引擎支持 ECDSA 签名生成和验证，以及 ECDH 密钥交换。

| 参数 | P-256 | P-384 | P-521 |
|------|-------|-------|-------|
| 密钥长度 | 256 位 | 384 位 | 521 位 |
| 点乘时间 | < 0.5ms | < 1ms | < 2ms |
| 签名时间 | < 1ms | < 2ms | < 4ms |
| 安全级别 | 128 位 | 192 位 | 256 位 |

#### 3.3.3 SM2 引擎
SM2 算法是中国国家密码管理局发布的非对称密码算法标准，基于椭圆曲线密码体制。SM2 引擎支持签名、密钥交换和公钥加密三种功能。引擎采用与 ECC 引擎相同的硬件结构，通过固件配置支持 SM2 曲线参数。

SM2 签名运算在 1ms 内完成（200MHz 时钟），满足国密应用场景需求。引擎支持 SM2 证书验证和密钥派生功能。

### 3.4 算法性能汇总

| 算法 | 操作 | 性能 | 功耗预算 |
|------|------|------|----------|
| AES-256-GCM | 加密 | 1.6 GB/s | 150 mW |
| SM4-CBC | 加密 | 800 MB/s | 80 mW |
| SHA-256 | 哈希 | 800 MB/s | 60 mW |
| SHA-512 | 哈希 | 1.2 GB/s | 80 mW |
| SM3 | 哈希 | 800 MB/s | 60 mW |
| SHA3-256 | 哈希 | 600 MB/s | 80 mW |
| RSA-2048 | 签名 | < 10 ms | 200 mW |
| ECC P-256 | 点乘 | < 0.5 ms | 150 mW |
| SM2 | 签名 | < 1 ms | 150 mW |

## 4. 真随机数生成器

### 4.1 TRNG 架构
真随机数生成器基于物理随机源，采用熵源、数字化电路和后处理模块三级架构。熵源采用环形振荡器采样电路，利用热噪声产生随机比特。数字化电路对熵源输出进行采样和去偏处理。后处理模块使用 SHA-256 哈希函数对原始随机数进行熵提取和均匀化。

TRNG 满足 NIST SP 800-90B 和 AIS-31 随机数测试要求，可用于密钥生成和密码学应用。生成器支持在线健康测试，检测熵源异常和时钟故障。

```
┌──────────────────────────────────────────────────────────────┐
│                    TRNG Architecture                          │
├──────────────────────────────────────────────────────────────┤
│  ┌─────────┐   ┌─────────┐   ┌─────────┐   ┌─────────────┐  │
│  │ Ring    │   │  LFSR   │   │  Von    │   │  SHA-256    │  │
│  │ OSC     │──▶│Sampler  │──▶│ Neumann │──▶│  Extractor  │──▶│
│  │ Entropy │   │ Circuit │   │ De-bias │   │  & DRBG     │  │
│  └─────────┘   └─────────┘   └─────────┘   └─────────────┘  │
│       │              │               │                       │
│       └──────────────┴───────────────┘                       │
│                      ▼                                        │
│            ┌─────────────────────┐                           │
│            │  Health Test &      │                           │
│            │  Entropy Estimation │                           │
│            └─────────────────────┘                           │
└──────────────────────────────────────────────────────────────┘
```

### 4.2 性能规格

| 参数 | 规格 |
|------|------|
| 随机数输出速率 | > 10 Mbps |
| 熵源质量 | > 0.997 比特/比特 |
| 预取延迟 | < 100 周期 |
| FIFO 深度 | 32 × 256 位 |
| 健康测试 | NIST SP 800-90B |

## 5. 密钥管理

### 5.1 密钥存储
密钥存储采用专用安全存储区域，与系统内存物理隔离。存储区域支持以下安全特性：硬件访问控制，仅授权模块可读取密钥；密钥自毁机制，在检测到物理攻击时擦除密钥；防侧信道攻击设计，恒定时间密钥访问。

存储容量支持最多 32 个密钥条目，每个条目可存储最大 256 位密钥。密钥 ID 用于软件引用，实际密钥内容对软件不可见。

### 5.2 密钥派生
密钥派生功能支持以下算法：HKDF-SHA256 用于从主密钥派生会话密钥；PBKDF2 用于从口令派生密钥；SMKDF 用于国密密钥派生。派生函数在专用硬件模块中执行，防止密钥泄露。

### 5.3 密钥生命周期管理

| 状态 | 描述 | 安全级别 |
|------|------|----------|
| 生成 | 密钥由 TRNG 或外部注入生成 | ASIL-D |
| 存储 | 密钥驻留在安全存储区域 | ASIL-D |
| 使用 | 密钥被加载到运算引擎 | ASIL-B |
| 派生 | 密钥用于派生子密钥 | ASIL-B |
| 销毁 | 密钥从存储中清除 | ASIL-D |

### 5.4 安全启动支持
Crypto 模块支持安全启动流程中的以下功能：镜像完整性验证，使用 SHA-256/RSA-2048 验证启动镜像；镜像解密，使用 AES-256-GCM 解密加密镜像；安全日志，使用 HMAC-SHA256 记录启动过程；证书验证，支持 X.509 证书链验证。

启动流程中，Boot ROM 中的根密钥验证 Primary Bootloader 的签名，然后 Primary Bootloader 验证 Secondary Bootloader 和应用镜像。Crypto 模块提供硬件加速的签名验证功能，确保启动过程的安全性和效率。

## 6. 安全特性

### 6.1 故障注入防护
Crypto 模块采用以下措施防护故障注入攻击：冗余计算，关键运算执行两次并比较结果；完整性校验，定期验证寄存器和状态机状态；时间冗余，关键路径添加时间冗余检测。模块支持 ISO 26262 ASIL-D 等级的故障检测，诊断覆盖率 > 99%。

### 6.2 侧信道攻击防护
针对侧信道攻击的防护措施包括：恒定时间实现，所有密码学运算采用恒定时间算法；掩码技术，敏感数据使用掩码保护；功率平衡，逻辑门级的功率平衡设计。模块通过 Common Criteria EAL4+ 认证要求的侧信道测试。

### 6.3 访问控制
Crypto 模块的访问控制机制包括：APB 寄存器访问权限控制，分为用户/管理员/安全三个权限等级；密钥访问授权，需通过安全 monitor 授权才能加载密钥；操作模式限制，某些敏感操作只能在特定模式下执行。

## 7. 功耗管理

### 7.1 功耗预算

| 工作状态 | 功耗预算 | 描述 |
|----------|----------|------|
| Active (全速) | < 500 mW | 所有引擎同时工作 |
| Active (典型) | < 300 mW | 单引擎典型负载 |
| Standby | < 10 mW | 时钟门控，寄存器保持 |
| Shutdown | < 1 mW | 电源门控，状态丢失 |

### 7.2 功耗优化技术
模块采用以下功耗优化技术：时钟门控，未使用的引擎自动关闭时钟；电源门控，支持细粒度的电源域控制；动态频率缩放，根据负载调整工作频率；数据通路优化，减少不必要的寄存器翻转。

## 8. 面积估算

### 8.1 面积分解

| 组件 | 面积 (mm²) | 门数 (K gates) |
|------|------------|----------------|
| AES 引擎 | 0.15 | 120 |
| SHA 引擎 | 0.10 | 80 |
| RSA/ECC 引擎 | 0.30 | 240 |
| TRNG | 0.05 | 40 |
| 密钥管理 | 0.08 | 65 |
| 控制逻辑 | 0.07 | 55 |
| 接口逻辑 | 0.05 | 40 |
| 总计 (含 20% margin) | 0.96 | 768 |

## 9. 验证计划

### 9.1 验证策略
验证采用分层验证策略：模块级验证使用 UVM 环境验证各子模块功能；子系统级验证验证模块间协作和接口协议；系统级验证在 SoC 环境中验证完整功能。

### 9.2 覆盖率目标

| 覆盖率类型 | 目标 |
|------------|------|
| 代码覆盖率 | > 95% |
| 功能覆盖率 | > 100% |
| 断言覆盖率 | > 90% |
| 故障覆盖率 | > 99% (FMEDA) |

## 10. 时序约束

### 10.1 时钟域
Crypto 模块包含以下时钟域：apb_clk 用于 APB 接口寄存器，时钟频率 100MHz；crypto_clk 用于加密运算引擎，时钟频率 200MHz；trng_clk 用于 TRNG 独立时钟，频率 50MHz。跨时钟域使用异步 FIFO 进行隔离。

### 10.2 SDC 约束
目标时钟频率：APB 接口 100MHz，加密引擎 200MHz。输入延迟：0.5ns 到 1.0ns（IO 约束）。输出延迟：0.5ns 到 1.0ns（IO 约束）。时钟抖动：100ps（最大）。时钟不确定性：150ps（建立时间）。

## 11. 复位策略

### 11.1 复位域
Crypto 模块包含以下复位域：presetzn 用于 APB 接口和寄存器，同步复位；crypto_rstn 用于加密引擎，同步复位；trng_rstn 用于 TRNG，独立复位。复位优先级：presetzn 最高，可复位所有模块。

### 11.2 上电复位时序
上电后，模块执行以下复位序列：等待电源稳定（最小 100us）；释放 presetzn，等待 16 个 apb_clk 周期；释放 crypto_rstn，等待 32 个 crypto_clk 周期；释放 trng_rstn，等待 16 个 trng_clk 周期；软件配置寄存器使能模块。

## 12. 版本历史

| 版本 | 日期 | 作者 | 描述 |
|------|------|------|------|
| 0.1 | 2026-01-18 | YaoGuang Team | 初始版本 |
