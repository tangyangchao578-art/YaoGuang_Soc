# 摇光(YaoGuang) SoC NoC 互联架构规格

## 文档信息

| 项目 | 内容 |
|------|------|
| 文档版本 | V1.0 |
| 创建日期 | 2026-01-19 |
| 最后更新 | 2026-01-19 |
| 状态 | 草稿 |
| 负责人 | NoC 架构师 |
| 关联文档 | 架构规格书 (01_Architecture_Spec_YaoGuang_SoC.md) |

---

## 1. 概述

### 1.1 NoC 设计目标

| 指标 | 目标值 | 备注 |
|------|--------|------|
| **峰值带宽** | ≥ 500 GB/s | 全芯片 |
| **延迟** | ≤ 20 cycles | 典型路径 |
| **频率** | 2.0 GHz | 目标频率 |
| **能效** | ≤ 2 pJ/bit | 每比特能耗 |
| **面积** | ≤ 8 mm² | NoC 总面积 |
| **功耗** | ≤ 3W | 峰值功耗 |

### 1.2 NoC 拓扑结构

采用 **分层混合拓扑**:
- **2D Mesh** 局部互连 (CPU 集群内部)
- **Crossbar** 全局互连 (主控制器)
- **环形** 备用路径 (容错)

---

## 2. NoC 架构总览

### 2.1 互联层次

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         全局互联层 (Global NoC)                          │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    Crossbar Switch (64x64)                      │   │
│  │  - 64 个端口                                                    │   │
│  │  - 512-bit 数据通路                                            │   │
│  │  - 分布式仲裁                                                  │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│         │         │         │         │         │         │             │
└─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────────┘
          │         │         │         │         │         │
          ▼         ▼         ▼         ▼         ▼         ▼
┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐
│   CPU 集群   │ │   CPU 集群   │ │   NPU 集群   │ │   NPU 集群   │
│   (ACE)     │ │   (ACE)     │ │   (AXI)     │ │   (AXI)     │
└─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘
```

### 2.2 端口分配

| 端口号 | masters/slaves | 带宽需求 | 优先级 |
|--------|----------------|----------|--------|
| 0-7 | 8x Cortex-A78AE (ACE) | 64 GB/s | 高 |
| 8-9 | 2x Cortex-R52 (AXI) | 32 GB/s | 高 (安全) |
| 10-13 | 4x NPU Cluster (AXI) | 200 GB/s | 高 |
| 14-15 | GPU Cluster (AXI) | 64 GB/s | 中 |
| 16-17 | ISP (AXI) | 32 GB/s | 中 |
| 18 | LPDDR5 MC (AXI) | 200 GB/s | 高 |
| 19 | L3 Cache (ACE) | 128 GB/s | 高 |
| 20-23 | PCIe Controller (AXI) | 32 GB/s | 中 |
| 24-25 | Ethernet (AXI) | 16 GB/s | 低 |
| 26-27 | USB (AXI) | 16 GB/s | 低 |
| 28-31 | 其他外设 (APB) | 2 GB/s | 低 |

---

## 3. Switch 架构

### 3.1 Crossbar Switch 规格

| 参数 | 规格 |
|------|------|
| **端口数** | 64 |
| **数据位宽** | 512-bit |
| **频率** | 2.0 GHz |
| **峰值带宽** | 512 GB/s (64 ports × 512-bit × 2 GHz / 8) |
| **交换方式** | 虚拟通道 (VC) 交换 |
| **仲裁方式** | 轮询 + 优先级仲裁 |
| **缓冲深度** | 64 flits/端口 |
| **VC 数量** | 4 VCs/端口 |

### 3.2 Switch 微架构

```
┌─────────────────────────────────────────────────────────────────┐
│                     Crossbar Switch                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐           │
│  │ Input   │  │ Input   │  │ Input   │  │ Input   │           │
│  │ Port 0  │  │ Port 1  │  │ Port 2  │  │ Port 3  │           │
│  │ (4 VCs) │  │ (4 VCs) │  │ (4 VCs) │  │ (4 VCs) │           │
│  └────┬────┘  └────┬────┘  └────┬────┘  └────┬────┘           │
│       │            │            │            │                  │
│       └────────────┴────────────┴────────────┘                  │
│                           │                                      │
│                    ┌──────▼──────┐                               │
│                    │   VC        │                               │
│                    │   Allocator │                               │
│                    │  (64x64)    │                               │
│                    └──────┬──────┘                               │
│                           │                                      │
│                    ┌──────▼──────┐                               │
│                    │  Crossbar   │                               │
│                    │  (64x64)    │                               │
│                    │ 512-bit     │                               │
│                    └──────┬──────┘                               │
│                           │                                      │
│       ┌────────────┬──────┴──────┬────────────┐                  │
│       │            │            │            │                  │
│       ▼            ▼            ▼            ▼                  │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐           │
│  │ Output  │  │ Output  │  │ Output  │  │ Output  │           │
│  │ Port 0  │  │ Port 1  │  │ Port 2  │  │ Port 3  │           │
│  └─────────┘  └─────────┘  └─────────┘  └─────────┘           │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 3.3 仲裁器设计

| 仲裁策略 | 适用场景 | 说明 |
|----------|----------|------|
| **轮询仲裁** | 同优先级请求 | 公平性保证 |
| **固定优先级** | 不同优先级 | 低延迟响应 |
| **加权轮询** | 差异化服务 | 带宽分配 |
| **最快路径** | 低延迟需求 | 最短路径优先 |

---

## 4. 虚拟通道 (VC) 设计

### 4.1 VC 配置

| VC 编号 | 优先级 | 流量类别 | 服务质量 |
|---------|--------|----------|----------|
| **VC0** | 最高 | 安全关键流量 | 确定性延迟 |
| **VC1** | 高 | 实时流量 | 低延迟 |
| **VC2** | 中 | 大块数据传输 | 高吞吐 |
| **VC3** | 低 | 尽力而为 | 背景流量 |

### 4.2 流量控制

| 控制类型 | 实现 | 优势 |
|----------|------|------|
| **Credit-based** | 端到端信用 | 无死锁 |
| **Pause Frame** | 链路级暂停 | 简单实现 |
| **优先级流控** | VC 独立控制 | QoS 保证 |

---

## 5. 服务质量 (QoS) 设计

### 5.1 QoS 机制

| 机制 | 实现 | 效果 |
|------|------|------|
| **优先级队列** | 4 级优先级 | 差异化延迟 |
| **带宽保证** | Token Bucket | 带宽分配 |
| **延迟上限** | Latency Budget | 确定性延迟 |
| **流量整形** | Rate Limiter | 流量平滑 |

### 5.2 QoS 配置

| 流量类型 | 优先级 | 带宽保证 | 延迟上限 |
|----------|--------|----------|----------|
| **安全岛流量** | 3 | 10% | < 10 cycles |
| **CPU 缓存访问** | 2 | 30% | < 20 cycles |
| **NPU 数据传输** | 2 | 40% | < 50 cycles |
| **外设 DMA** | 1 | 10% | < 100 cycles |
| **调试流量** | 0 | 10% | Best Effort |

---

## 6. 一致性支持

### 6.1 ACE 协议支持

| 特性 | 支持 | 说明 |
|------|------|------|
| **snoop** | 是 | Cache 一致性监听 |
| **DVM** | 是 | 分布式虚拟内存 |
| ** Barriers** | 是 | 内存屏障 |
| **Cache maintenance** | 是 | Cache 维护操作 |

### 6.2 Snoop Filter

| 参数 | 规格 |
|------|------|
| 大小 | 2 MB |
| 组织 | 全相联 |
| 条目数 | 32K entries |
| 延迟 | 2 cycles |
| 误判率 | < 0.1% |

---

## 7. 路由算法

### 7.1 路由策略

| 路由类型 | 适用场景 | 路径选择 |
|----------|----------|----------|
| **XY 路由** | 2D Mesh | X 优先，Y 次之 |
| **完全自适应** | Crossbar | 任意路径 |
| **确定性路由** | 环形 | 固定路径 |
| **容错路由** | 故障恢复 | 绕行路径 |

### 7.2 负载均衡

| 策略 | 实现 | 效果 |
|------|------|------|
| **ECMP** | 多路径等价路由 | 带宽聚合 |
| **自适应路由** | 动态路径选择 | 拥塞避免 |
| **倾斜路由** | 热点分散 | 负载均衡 |

---

## 8. 功耗管理

### 8.1 功耗预算

| 模块 | 动态功耗 (W) | 静态功耗 (W) | 峰值功耗 (W) |
|------|--------------|--------------|--------------|
| **Crossbar Switch** | 1.2 | 0.3 | 1.5 |
| **64x Router** | 0.6 | 0.2 | 0.8 |
| **VC Buffer** | 0.4 | 0.1 | 0.5 |
| **QoS Logic** | 0.2 | 0.05 | 0.25 |
| **时钟树** | 0.3 | 0.1 | 0.4 |
| **总计** | **2.7** | **0.75** | **3.45** |

### 8.2 功耗优化

| 技术 | 应用 | 节省功耗 |
|------|------|----------|
| **时钟门控** | 空闲端口 | 20-30% |
| **电源门控** | 未使用链路 | 40-60% |
| **频率缩放** | 低负载时 | 10-20% |
| **数据门控** | 零数据抑制 | 5-10% |

---

## 9. 面积分析

### 9.1 面积预算

| 模块 | 面积 (mm²) | 占比 |
|------|------------|------|
| **Crossbar Switch** | 3.5 | 44% |
| **64x Router** | 2.0 | 25% |
| **VC Buffer** | 1.0 | 13% |
| **QoS Logic** | 0.5 | 6% |
| **时钟复位** | 0.5 | 6% |
| **其他** | 0.5 | 6% |
| **总计** | **8.0** | **100%** |

---

## 10. 性能分析

### 10.1 带宽分析

| 路径 | 理论带宽 | 实际带宽 | 利用率 |
|------|----------|----------|--------|
| CPU → L3 | 128 GB/s | 100 GB/s | 78% |
| NPU → Memory | 200 GB/s | 160 GB/s | 80% |
| GPU → Memory | 64 GB/s | 48 GB/s | 75% |
| PCIe → Memory | 32 GB/s | 25 GB/s | 78% |

### 10.2 延迟分析

| 路径 | 典型延迟 | 最坏延迟 | 备注 |
|------|----------|----------|------|
| CPU → L3 | 15 cycles | 25 cycles | 缓存访问 |
| NPU → Memory | 30 cycles | 50 cycles | DDR 访问 |
| CPU → NPU | 20 cycles | 40 cycles | 跨集群 |
| 外设 → Memory | 40 cycles | 80 cycles | DMA |

---

## 11. 安全机制

### 11.1 安全特性

| 特性 | 实现 | ASIL 等级 |
|------|------|----------|
| **流量隔离** | VC + 端口隔离 | ASIL-D |
| **错误检测** | ECC + CRC | ASIL-B |
| **看门狗** | 交易超时检测 | ASIL-B |
| **访问控制** | 地址过滤 | ASIL-B |

### 11.2 故障处理

| 故障类型 | 检测方法 | 响应策略 |
|----------|----------|----------|
| **链路错误** | CRC 校验 | 重传 + 告警 |
| **死锁** | 超时检测 | 路由解除 |
| **拥塞** | 队列深度监控 | 流量限制 |

---

## 12. 验证计划

### 12.1 验证目标

| 验证类型 | 覆盖率目标 | 工具 |
|----------|------------|------|
| **功能覆盖率** | 100% | UVM |
| **协议一致性** | 100% | ACE/AXI VIP |
| **性能验证** | 目标达成 | 仿真 + 性能模型 |
| **形式验证** | 关键模块 | JasperGold |

### 12.2 验证用例

| 用例类别 | 用例数 | 说明 |
|----------|--------|------|
| **协议测试** | 200+ | AXI/ACE 协议测试 |
| **功能测试** | 300+ | 路由和交换测试 |
| **QoS 测试** | 100+ | 服务质量测试 |
| **压力测试** | 50+ | 极限负载测试 |
| **异常测试** | 100+ | 错误注入测试 |

---

## 13. 交付物和时间表

| 交付物 | 截止日期 | 状态 |
|--------|----------|------|
| NoC 架构规格 | 2026-02-28 | 未开始 |
| Switch 设计 | 2026-04-15 | 未开始 |
| QoS 实现 | 2026-05-15 | 未开始 |
| RTL 代码冻结 | 2026-07-31 | 未开始 |
| DV 验证通过 | 2026-10-31 | 未开始 |

---

## 14. 审批

| 角色 | 姓名 | 签名 | 日期 |
|------|------|------|------|
| NoC 架构师 | [待确认] | - | - |
| 首席架构师 | [待确认] | - | - |
| 项目经理 | [待确认] | - | - |

---

**文档版本**: V1.0  
**最后更新**: 2026-01-19  
**状态**: 草稿  
**下一步**: 开始 RTL 代码开发

---
*本规格书作为 NoC 互联架构详细设计的指导文件。*