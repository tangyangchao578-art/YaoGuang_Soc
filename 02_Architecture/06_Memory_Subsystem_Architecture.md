# 摇光(YaoGuang) SoC 存储器子系统架构规格

## 文档信息

| 项目 | 内容 |
|------|------|
| 文档版本 | V1.0 |
| 创建日期 | 2026-01-19 |
| 最后更新 | 2026-01-19 |
| 状态 | 草稿 |
| 负责人 | 存储器架构师 |
| 关联文档 | 架构规格书 (01_Architecture_Spec_YaoGuang_SoC.md) |

---

## 1. 概述

### 1.1 存储器子系统组成

| 模块 | 类型 | 大小 | 带宽 | 用途 |
|------|------|------|------|------|
| **LPDDR5 控制器** | 外部 DRAM | 32-64 GB | 200 GB/s | 主内存 |
| **L3 Cache** | eDRAM/SRAM | 8 MB | 256 GB/s | 片上共享缓存 |
| **片上 SRAM** | On-chip SRAM | 16 MB | 256 GB/s | NPU 权重/激活 |
| **TCM** | Tightly Coupled | 2 MB | 64 GB/s | 安全处理器 |

### 1.2 设计目标

| 指标 | 目标值 | 备注 |
|------|--------|------|
| **内存带宽** | ≥ 200 GB/s | LPDDR5 |
| **内存容量** | 32-64 GB | 可配置 |
| **L3 命中率** | ≥ 85% | 优化配置 |
| **能效** | ≤ 10 pJ/bit | DRAM 访问 |
| **功耗预算** | ≤ 6W | 存储器子系统 |
| **面积预算** | ≤ 18 mm² | 约占 15% |

---

## 2. LPDDR5 控制器架构

### 2.1 控制器规格

| 参数 | 规格 |
|------|------|
| **标准** | LPDDR5 (JESD209-5) |
| **数据速率** | 6400 MT/s |
| **通道数** | 2 x 16-bit |
| **峰值带宽** | 200 GB/s (双向) |
| **通道带宽** | 100 GB/s/通道 |
| **ECC** | SECDED (可选) |
| **命令队列** | 64 entries |
| **重排深度** | 32 transactions |

### 2.2 PHY 规格

| 参数 | 规格 |
|------|------|
| **I/O 速率** | 3200 MHz (DDR) |
| **I/O 电压** | 1.1V (Vddq) |
| **终端电阻** | 可编程 ODT |
| **校准** | 读/写 leveling |
| **ESD 保护** | 2 kV HBM |

### 2.3 DRAM 配置

| 参数 | 配置 A | 配置 B |
|------|--------|--------|
| **容量** | 32 GB (8x4GB) | 64 GB (8x8GB) |
| **组织** | 2 channels x 4 ranks | 2 channels x 4 ranks |
| **颗粒** | 16-bit x 16-bank | 16-bit x 16-bank |
| **刷新** | 7.8 μs tREFI | 7.8 μs tREFI |

### 2.4 控制器架构

```
┌─────────────────────────────────────────────────────────────────┐
│                    LPDDR5 Controller                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                  Front-End (AXI Interface)               │   │
│  │  - AXI4 Master/Slave 接口                                │   │
│  │  - 命令队列 (64 entries)                                │   │
│  │  - 事务重排 (Reorder Buffer)                            │   │
│  │  - QoS 调度 (优先级仲裁)                                │   │
│  └─────────────────────────────────────────────────────────┘   │
│                          │                                      │
│                          ▼                                      │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                 Command Scheduler                        │   │
│  │  - 行激活调度                                            │   │
│  │  - 刷新调度 (自动/手动)                                 │   │
│  │  - 功耗状态管理 (Active/Power-down/Self-refresh)       │   │
│  │  - _bank 冲突避免                                        │   │
│  └─────────────────────────────────────────────────────────┘   │
│                          │                                      │
│                          ▼                                      │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                   PHY Interface                          │   │
│  │  - DFI 4.0 接口                                         │   │
│  │  - 时序参数编程                                         │   │
│  │  - 训练引擎 (eye training)                              │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 2.5 功耗管理

| 状态 | 功耗 | 进入条件 |
|------|------|----------|
| **Active** | 2.5W/通道 | 正在访问 |
| **Power-down** | 50 mW/通道 | 无访问 > tCKCSD |
| **Self-refresh** | 30 mW/通道 | 所有 bank 预充电 |
| **Deep Power-down** | 5 mW/通道 | 长时间空闲 |

---

## 3. L3 Cache 架构

### 3.1 Cache 配置

| 参数 | 规格 |
|------|------|
| **大小** | 8 MB |
| **关联度** | 16 路组相联 |
| **块大小** | 64 Bytes |
| **替换策略** | Pseudo-LRU |
| **延迟** | 30-40 cycles |
| **带宽** | 256 GB/s (读 + 写) |
| **频率** | 2.0 GHz |
| **写策略** | 写回 + 写分配 |
| **包含性** | Non-inclusive |

### 3.2 访问带宽

| 访问类型 | 带宽 | 延迟 |
|----------|------|------|
| **单端口读** | 64 GB/s | 30 cycles |
| **单端口写** | 64 GB/s | 30 cycles |
| **双端口并发** | 128 GB/s | 35 cycles |
| **突发访问** | 256 GB/s | 40 cycles |

### 3.3 预取器配置

| 预取器 | 数量 | 预取策略 | 准确性 |
|--------|------|----------|--------|
| **顺序预取** | 2 | 线性地址序列 | 85% |
| **跨度预取** | 1 | 固定跨步模式 | 70% |
| **指令预取** | 1 | 分支目标 | 80% |

### 3.4 ECC 保护

| 参数 | 规格 |
|------|------|
| **ECC 宽度** | 8-bit SECDED |
| **检测能力** | 2-bit 错误 |
| **纠正能力** | 1-bit 错误 |
| **检测延迟** | 1 cycle |
| **纠正延迟** | 2 cycles |

---

## 4. 片上 SRAM 设计

### 4.1 SRAM 阵列分布

| 模块 | 大小 | Banks | 带宽 | 用途 |
|------|------|-------|------|------|
| **NPU Weight SRAM** | 8 MB | 64 | 128 GB/s | NPU 权重存储 |
| **NPU Activation SRAM** | 8 MB | 64 | 128 GB/s | NPU 激活存储 |
| **系统 SRAM** | 4 MB | 32 | 64 GB/s | 通用缓存 |
| **TCM (R52)** | 2 MB | 16 | 64 GB/s | 安全处理器 |

### 4.2 SRAM 特性

| 参数 | 规格 |
|------|------|
| **读延迟** | 1-2 cycles |
| **写延迟** | 1 cycle |
| **读带宽** | 512-bit/cycle/bank |
| **功耗** | 0.5 mW/MHz/MB |
| **面积** | 0.5 mm²/MB (7nm) |

### 4.3 ECC 保护

| 模块 | ECC 保护 | 检测 | 纠正 |
|------|----------|------|------|
| **NPU SRAM** | SECDED | 2-bit | 1-bit |
| **系统 SRAM** | SECDED | 2-bit | 1-bit |
| **TCM** | SECDED | 2-bit | 1-bit |

---

## 5. 存储层次结构

### 5.1 层次结构图

```
┌─────────────────────────────────────────────────────────────────────────┐
│                              存储层次                                    │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  CPU Core 0-7                                                           │
│  ├─ L1 I-Cache: 64 KB x 8  ───────────────────────────────────┐        │
│  ├─ L1 D-Cache: 64 KB x 8  ───────────────────────────────────┤        │
│  └─ L2 Cache: 512 KB x 8   ───────────────────────────────────┤        │
│                              │                                         │
│                              ▼                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  L3 Cache: 8 MB (16-way)                                        │   │
│  │  - 延迟: 30-40 cycles                                           │   │
│  │  - 带宽: 256 GB/s                                               │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                              │                                         │
│                              ▼                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  片上 SRAM: 16 MB                                               │   │
│  │  - Weight SRAM: 8 MB (NPU)                                     │   │
│  │  - Activation SRAM: 8 MB (NPU)                                 │   │
│  │  - TCM: 2 MB (Safety Island)                                   │   │
│  │  - 系统 SRAM: 4 MB                                             │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                              │                                         │
│                              ▼                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  LPDDR5 DRAM: 32-64 GB                                         │   │
│  │  - 带宽: 200 GB/s                                              │   │
│  │  - 延迟: 100-150 ns                                            │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 5.2 带宽分配

| 层级 | 峰值带宽 | 典型负载 | 利用率 |
|------|----------|----------|--------|
| **L1 Cache** | 2 TB/s | 500 GB/s | 25% |
| **L2 Cache** | 500 GB/s | 200 GB/s | 40% |
| **L3 Cache** | 256 GB/s | 150 GB/s | 60% |
| **片上 SRAM** | 256 GB/s | 180 GB/s | 70% |
| **LPDDR5** | 200 GB/s | 120 GB/s | 60% |

---

## 6. 功耗分析

### 6.1 功耗预算

| 模块 | 动态功耗 (W) | 静态功耗 (W) | 峰值功耗 (W) |
|------|--------------|--------------|--------------|
| **LPDDR5 Controller** | 1.5 | 0.3 | 1.8 |
| **LPDDR5 PHY** | 1.0 | 0.2 | 1.2 |
| **L3 Cache** | 1.2 | 0.4 | 1.6 |
| **NPU SRAM (16 MB)** | 1.5 | 0.5 | 2.0 |
| **系统 SRAM (4 MB)** | 0.4 | 0.1 | 0.5 |
| **TCM (2 MB)** | 0.2 | 0.1 | 0.3 |
| **时钟树** | 0.3 | 0.1 | 0.4 |
| **总计** | **6.1** | **1.7** | **7.8** |

### 6.2 功耗优化

| 技术 | 应用 | 节省功耗 |
|------|------|----------|
| **SRAM 关闭** | 低功耗模式 | 30-50% |
| **Bank 门控** | 未访问 Bank | 20-40% |
| **频率缩放** | 动态调整 | 10-20% |
| **刷新优化** | 温度自适应刷新 | 5-10% |

---

## 7. 面积分析

### 7.1 面积预算

| 模块 | 面积 (mm²) | 占比 |
|------|------------|------|
| **LPDDR5 Controller** | 1.5 | 8% |
| **LPDDR5 PHY** | 2.0 | 11% |
| **L3 Cache (8 MB)** | 4.0 | 22% |
| **NPU SRAM (16 MB)** | 6.0 | 33% |
| **系统 SRAM (4 MB)** | 2.0 | 11% |
| **TCM (2 MB)** | 1.0 | 6% |
| **接口逻辑** | 1.5 | 8% |
| **总计** | **18.0** | **100%** |

---

## 8. 性能分析

### 8.1 延迟分析

| 访问路径 | 典型延迟 | 最坏情况 |
|----------|----------|----------|
| **L1 Cache Hit** | 4 cycles | 4 cycles |
| **L2 Cache Hit** | 12 cycles | 15 cycles |
| **L3 Cache Hit** | 35 cycles | 50 cycles |
| **片上 SRAM** | 10 cycles | 20 cycles |
| **LPDDR5** | 100 ns | 200 ns |

### 8.2 带宽瓶颈分析

| 瓶颈 | 影响 | 缓解措施 |
|------|------|----------|
| **LPDDR5 带宽** | 限制 NPU 性能 | 增加 L3 命中率 |
| **L3 带宽** | 多核竞争 | 增加端口数 |
| **SRAM 带宽** | NPU 瓶颈 | 增加 Bank 数 |

---

## 9. 安全机制

### 9.1 安全特性

| 特性 | 实现 | ASIL 等级 |
|------|------|----------|
| **ECC 保护** | 所有存储器 | ASIL-D |
| **读写保护** | 地址过滤 | ASIL-B |
| **数据加密** | 内存加密 (可选) | ASIL-B |
| **完整性校验** | MAC 校验 | ASIL-B |

### 9.2 故障检测

| 故障类型 | 检测方法 | 响应 |
|----------|----------|------|
| **单比特错误** | ECC 纠正 | 纠正 + 记录 |
| **双比特错误** | ECC 检测 | 告警 + 中断 |
| **永久故障** | BIST 检测 | 隔离 + 降级 |

---

## 10. 验证计划

### 10.1 验证目标

| 验证类型 | 覆盖率目标 | 工具 |
|----------|------------|------|
| **功能覆盖率** | 100% | UVM |
| **性能验证** | 目标达成 | 性能模型 |
| **一致性验证** | 100% | AXI/ACE VIP |
| **可靠性验证** | ECC 100% | 故障注入 |

### 10.2 验证用例

| 用例类别 | 用例数 | 说明 |
|----------|--------|------|
| **功能测试** | 200+ | 读/写/刷新测试 |
| **性能测试** | 50+ | 带宽/延迟测试 |
| **压力测试** | 50+ | 极限负载测试 |
| **异常测试** | 100+ | ECC/错误注入测试 |

---

## 11. 交付物和时间表

| 交付物 | 截止日期 | 状态 |
|--------|----------|------|
| 存储器架构规格 | 2026-02-28 | 未开始 |
| LPDDR5 Controller 设计 | 2026-04-15 | 未开始 |
| L3 Cache 设计 | 2026-05-15 | 未开始 |
| RTL 代码冻结 | 2026-07-31 | 未开始 |
| DV 验证通过 | 2026-10-31 | 未开始 |

---

## 12. 审批

| 角色 | 姓名 | 签名 | 日期 |
|------|------|------|------|
| 存储器架构师 | [待确认] | - | - |
| 首席架构师 | [待确认] | - | - |
| 项目经理 | [待确认] | - | - |

---

**文档版本**: V1.0  
**最后更新**: 2026-01-19  
**状态**: 草稿  
**下一步**: 开始 RTL 代码开发

---
*本规格书作为存储器子系统详细设计的指导文件。*