# 摇光(YaoGuang) SoC NPU 子系统微架构规格

## 文档信息

| 项目 | 内容 |
|------|------|
| 文档版本 | V1.0 |
| 创建日期 | 2026-01-19 |
| 最后更新 | 2026-01-19 |
| 状态 | 草稿 |
| 负责人 | NPU 架构师 |
| 关联文档 | 架构规格书 (01_Architecture_Spec_YaoGuang_SoC.md) |

---

## 1. 概述

### 1.1 NPU 子系统组成

| 模块 | 数量 | 算力 (INT8) | 频率 | 安全等级 |
|------|------|-------------|------|---------|
| **NPU Cluster** | 4 | 75 TOPS/集群 | 1.5-2.0 GHz | ASIL-B |
| **NPU 控制器** | 1 | - | 1.5 GHz | ASIL-B |
| **权重缓存** | 4 | - | 2.0 GHz | ASIL-B |
| **激活缓存** | 4 | - | 2.0 GHz | ASIL-B |

### 1.2 设计目标

| 指标 | 目标值 | 备注 |
|------|--------|------|
| 总算力 (INT8) | ≥ 300 TOPS | 4x 75 TOPS |
| 总算力 (FP16) | ≥ 150 TFLOPS | 混合精度 |
| 能效比 | ≥ 5 TOPS/W | INT8 计算 |
| 功耗预算 | ≤ 25W | 峰值 |
| 面积预算 | ≤ 36 mm² | 约占 30% |
| 稀疏加速 | 1.5-2x | 结构化稀疏 |

---

## 2. NPU Cluster 微架构

### 2.1 集群架构总览

```
┌─────────────────────────────────────────────────────────────────┐
│                      NPU Cluster (75 TOPS)                       │
├─────────────────────────────────────────────────────────────────┤
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                    Weight Station                          │  │
│  │  - Weight SRAM: 2 MB                                       │  │
│  │  - Weight Decomp + Compression                            │  │
│  │  - Preload Engine                                         │  │
│  └───────────────────────────────────────────────────────────┘  │
│                              │                                   │
│                              ▼                                   │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                   MAC Array (1024 INT8)                   │  │
│  │  - 1024 INT8 MAC Units                                    │  │
│  │  - 512 INT16 MAC Units (可配置)                           │  │
│  │  - Pipelined: 4 stages                                    │  │
│  └───────────────────────────────────────────────────────────┘  │
│                              │                                   │
│                              ▼                                   │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                  Activation Station                       │  │
│  │  - Activation SRAM: 2 MB                                  │  │
│  │  - ReLU/PReLU/SiLU Activation                            │  │
│  │  - Batch Normalization                                    │  │
│  └───────────────────────────────────────────────────────────┘  │
│                              │                                   │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                    Output Buffer                          │  │
│  │  - Output SRAM: 1 MB                                      │  │
│  │  - Pooling (Max/Avg)                                      │  │
│  │  - Stride/Padding                                        │  │
│  └───────────────────────────────────────────────────────────┘  │
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                    Control Unit                            │  │
│  │  - Tensor Operation Scheduler                            │  │
│  │  - Loop Nest Generator                                    │  │
│  │  - Instruction Decoder                                    │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 MAC 阵列配置

#### 2.2.1 计算单元规格

| 参数 | INT8 模式 | FP16 模式 |
|------|-----------|-----------|
| MAC 单元数 | 1024 | 512 |
| 峰值算力 | 75 TOPS | 37.5 TFLOPS |
| 频率 | 2.0 GHz | 2.0 GHz |
| 吞吐率 | 1024 ops/cycle | 512 ops/cycle |
| 数据精度 | INT8 | FP16/BFP16 |
| 累加精度 | INT32 | FP32 |

#### 2.2.2 流水线设计

| 阶段 | 周期数 | 功能 |
|------|--------|------|
| **Stage 1** | 1 | 输入读取 + 权重读取 |
| **Stage 2** | 1 | 乘法运算 |
| **Stage 3** | 1 | 累加运算 |
| **Stage 4** | 1 | 激活函数 + 归一化 |
| **总计** | **4 cycles** | 流水线深度 |

### 2.3 片上存储架构

#### 2.3.1 Weight SRAM

| 参数 | 规格 |
|------|------|
| 大小 | 2 MB/集群 |
| 组织 | 16 banks x 128 KB |
| 位宽 | 512-bit/bank |
| 带宽 | 256 GB/s (峰值) |
| 延迟 | 5-10 cycles |
| ECC | SECDED |
| 压缩 | 支持 (2-4x 压缩率) |

#### 2.3.2 Activation SRAM

| 参数 | 规格 |
|------|------|
| 大小 | 2 MB/集群 |
| 组织 | 16 banks x 128 KB |
| 位宽 | 512-bit/bank |
| 带宽 | 256 GB/s (峰值) |
| 延迟 | 5-10 cycles |
| ECC | SECDED |
| 双缓冲 | 支持 (乒乓操作) |

#### 2.3.3 Output Buffer

| 参数 | 规格 |
|------|------|
| 大小 | 1 MB/集群 |
| 组织 | 8 banks x 128 KB |
| 位宽 | 512-bit/bank |
| 带宽 | 128 GB/s |
| 延迟 | 3-5 cycles |
| 功能 | 池化 + 格式化 |

---

## 3. 稀疏计算引擎

### 3.1 稀疏技术规格

| 特性 | 规格 |
|------|------|
| **稀疏类型** | 结构化稀疏 + 非结构化稀疏 |
| **结构化稀疏** | 2:4, 4:8 模式 |
| **非结构化稀疏** | 任意 0 模式 |
| **有效算力提升** | 1.5-2x |
| **压缩率** | 2-4x (典型) |

### 3.2 稀疏处理流程

```
输入权重 ──→ 稀疏编码 ──→ 压缩存储 ──→ 解码 ──→ MAC 阵列
                    │
                    └──→ 索引表 (非零位置)
```

### 3.3 稀疏解码器

| 参数 | 规格 |
|------|------|
| 解码吞吐量 | 512 weights/cycle |
| 索引带宽 | 64 entries/cycle |
| 压缩表大小 | 32 KB |
| 延迟 | 2-3 cycles |

---

## 4. 数据流优化

### 4.1 数据复用策略

| 复用类型 | 描述 | 带宽节省 |
|----------|------|----------|
| **权重复用** | 多激活复用同一权重 | 8-16x |
| **激活复用** | 多权重复用同一激活 | 4-8x |
| **累加复用** | 权重分块累加 | 2-4x |

### 4.2 数据预取策略

| 预取类型 | 触发条件 | 预取深度 |
|----------|----------|----------|
| **顺序预取** | 连续地址访问 | 8 tiles |
| **跨步预取** | 固定跨步模式 | 4 tiles |
| **指令预取** | 指令流预测 | 16 instructions |

---

## 5. 支持的网络模型

### 5.1 神经网络支持

| 网络类型 | 支持程度 | 优化 |
|----------|----------|------|
| **CNN** | 完整支持 | Winograd, Im2Col |
| **Transformer** | 完整支持 | FlashAttention |
| **RNN/LSTM** | 完整支持 | 专用单元 |
| **Moe** | 完整支持 | 多专家并行 |

### 5.2 算子支持

| 算子类别 | 支持算子 |
|----------|----------|
| **卷积** | Conv1D/2D/3D, Depthwise, Separable |
| **激活** | ReLU, PReLU, SiLU, GeLU, Swish |
| **池化** | Max, Avg, Global |
| **归一化** | BatchNorm, LayerNorm |
| **注意力** | Self-Attention, Multi-Head |
| **矩阵运算** | MatMul, GEMM |
| **变形** | Reshape, Transpose, Permute |

---

## 6. 调度与控制

### 6.1 调度器架构

```
┌─────────────────────────────────────────┐
│            Tensor Programmer             │
│  - 计算图优化                           │
│  - 算子融合                             │
│  - 内存规划                             │
└────────────────┬────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────┐
│           Command Dispatch               │
│  - 指令发射                             │
│  - 资源分配                             │
│  - 依赖检查                             │
└────────────────┬────────────────────────┘
                 │
    ┌────────────┼────────────┐
    ▼            ▼            ▼
┌───────┐  ┌───────┐  ┌───────┐
│Cluster│  │Cluster│  │Cluster│
│  0    │  │  1    │  │  2    │
└───────┘  └───────┘  └───────┘
```

### 6.2 指令集架构

| 指令类型 | 格式 | 功能 |
|----------|------|------|
| **计算指令** | CONV/MATMUL/FC | 卷积/矩阵乘 |
| **激活指令** | ACTIVATION | 激活函数 |
| **池化指令** | POOL | 池化操作 |
| **搬迁指令** | MOVE | 数据移动 |
| **控制指令** | LOOP/BRANCH | 控制流 |

### 6.3 指令格式

```
┌─────────────────────────────────────────────────────────────────┐
│  opcode (8) │ rd (4) │ rn (4) │ rm (4) │ imm (12) │ flag (4)   │
├─────────────────────────────────────────────────────────────────┤
│  算子类型   │ 目的   │ 源1    │ 源2    │ 立即数   │ 标志位     │
└─────────────────────────────────────────────────────────────────┘
```

---

## 7. 接口规格

### 7.1 NoC 接口

| 接口类型 | 协议 | 位宽 | 带宽 |
|----------|------|------|------|
| **读请求** | AXI4 | 256-bit | 64 GB/s |
| **读响应** | AXI4 | 512-bit | 128 GB/s |
| **写请求** | AXI4 | 512-bit | 128 GB/s |
| **写响应** | AXI4 | 32-bit | 8 GB/s |

### 7.2 内存带宽需求

| 访问类型 | 带宽需求 | 说明 |
|----------|----------|------|
| **权重加载** | 100 GB/s | 典型推理负载 |
| **激活加载** | 80 GB/s | 典型推理负载 |
| **输出存储** | 60 GB/s | 典型推理负载 |
| **峰值带宽** | 200 GB/s | 4 集群总和 |

### 7.3 中断接口

| 中断类型 | 优先级 | 功能 |
|----------|--------|------|
| **计算完成** | 中 | 计算任务结束 |
| **错误** | 高 | 计算错误检测 |
| **看门狗** | 最高 | 超时检测 |

---

## 8. 功耗分析

### 8.1 功耗预算

| 模块 | 动态功耗 (W) | 静态功耗 (W) | 峰值功耗 (W) |
|------|--------------|--------------|--------------|
| **MAC 阵列** | 12.0 | 2.0 | 14.0 |
| **Weight SRAM** | 3.0 | 1.0 | 4.0 |
| **Activation SRAM** | 3.0 | 1.0 | 4.0 |
| **控制逻辑** | 1.0 | 0.3 | 1.3 |
| **接口** | 1.0 | 0.2 | 1.2 |
| **时钟树** | 0.5 | 0.1 | 0.6 |
| **总计/集群** | **20.5** | **4.6** | **25.1** |
| **4 集群总计** | **82.0** | **18.4** | **100.4** |

### 8.2 功耗优化技术

| 技术 | 应用 | 节省功耗 |
|------|------|----------|
| **时钟门控** | MAC 阵列空闲时 | 30-40% |
| **电源门控** | 未使用集群 | 60-80% |
| **SRAM 关闭** | 低功耗模式 | 20-30% |
| **电压缩放** | 降低工作电压 | 10-15% |
| **稀疏跳零** | 跳过零值计算 | 30-50% |

---

## 9. 面积分析

### 9.1 面积预算

| 模块 | 面积 (mm²) | 占比 |
|------|------------|------|
| **MAC 阵列 (x4)** | 16.0 | 44% |
| **Weight SRAM (x4)** | 8.0 | 22% |
| **Activation SRAM (x4)** | 8.0 | 22% |
| **控制逻辑 (x4)** | 2.0 | 6% |
| **接口逻辑** | 1.5 | 4% |
| **时钟树** | 0.5 | 1% |
| **总计/集群** | **36.0** | **100%** |

### 9.2 面积优化

| 优化技术 | 目标节省 |
|----------|----------|
| **MAC 阵列折叠** | 10-15% |
| **SRAM 位宽优化** | 5-8% |
| **标准单元库选择** | 3-5% |

---

## 10. 性能建模

### 10.1 性能指标

| 指标 | INT8 | FP16 | 测试条件 |
|------|------|------|----------|
| **单集群算力** | 75 TOPS | 37.5 TFLOPS | @2.0GHz |
| **4 集群总算力** | 300 TOPS | 150 TFLOPS | - |
| **能效比** | 5 TOPS/W | 2.5 TFLOPS/W | 峰值 |
| **推理延迟 (ResNet-50)** | < 5 ms | < 8 ms | 224x224 |
| **推理延迟 (BERT-Base)** | < 10 ms | < 15 ms | 512 tokens |

### 10.2 网络性能

| 网络 | 分辨率 | INT8 延迟 | FP16 延迟 | 吞吐率 |
|------|--------|-----------|-----------|--------|
| ResNet-50 | 224x224 | 4.2 ms | 6.8 ms | 238 img/s |
| YOLOv8 | 640x640 | 12.5 ms | 18.2 ms | 80 fps |
| BERT-Base | 512 | 8.5 ms | 12.3 ms | 117 seq/s |
| Stable Diffusion | 512x512 | 85 ms | 120 ms | 12 img/s |

---

## 11. 安全机制

### 11.1 安全特性

| 特性 | 实现 | ASIL 等级 |
|------|------|----------|
| **ECC 保护** | Weight/Activation SRAM | ASIL-B |
| **看门狗** | 计算超时检测 | ASIL-B |
| **寄存器保护** | 配置寄存器 ECC | ASIL-B |
| **接口校验** | AXI 协议检查 | ASIL-B |

### 11.2 故障检测

| 故障类型 | 检测方法 | 覆盖率 |
|----------|----------|--------|
| **永久故障** | BIST 检测 | > 95% |
| **瞬态故障** | 重复计算校验 | > 90% |
| **配置错误** | 范围检查 | 100% |

---

## 12. 验证计划

### 12.1 验证目标

| 验证类型 | 覆盖率目标 | 工具 |
|----------|------------|------|
| **功能覆盖率** | 100% | UVM |
| **代码覆盖率** | ≥ 95% | VCS |
| **断言覆盖率** | ≥ 90% | SVA |
| **性能验证** | 目标达成 | C++ Model |

### 12.2 验证用例

| 用例类别 | 用例数 | 说明 |
|----------|--------|------|
| **算子测试** | 200+ | 单算子功能验证 |
| **网络测试** | 50+ | 完整网络验证 |
| **稀疏测试** | 50+ | 稀疏计算验证 |
| **异常测试** | 100+ | 边界和错误测试 |
| **性能测试** | 30+ | 性能基准测试 |

---

## 13. 交付物和时间表

| 交付物 | 截止日期 | 状态 |
|--------|----------|------|
| NPU 微架构规格 | 2026-02-28 | 未开始 |
| MAC 阵列设计 | 2026-04-15 | 未开始 |
| 稀疏引擎设计 | 2026-05-15 | 未开始 |
| RTL 代码冻结 | 2026-08-31 | 未开始 |
| DV 验证通过 | 2026-11-30 | 未开始 |

---

## 14. 审批

| 角色 | 姓名 | 签名 | 日期 |
|------|------|------|------|
| NPU 架构师 | [待确认] | - | - |
| 首席架构师 | [待确认] | - | - |
| 项目经理 | [待确认] | - | - |

---

**文档版本**: V1.0  
**最后更新**: 2026-01-19  
**状态**: 草稿  
**下一步**: 开始 RTL 代码开发

---
*本规格书作为 NPU 子系统详细设计的指导文件。*