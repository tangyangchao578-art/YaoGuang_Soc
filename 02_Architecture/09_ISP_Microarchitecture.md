# 摇光(YaoGuang) SoC ISP 微架构规格

## 文档信息

| 项目 | 内容 |
|------|------|
| 文档版本 | V1.0 |
| 创建日期 | 2026-01-19 |
| 最后更新 | 2026-01-19 |
| 状态 | 草稿 |
| 负责人 | ISP 架构师 |
| 关联文档 | 架构规格书 (01_Architecture_Spec_YaoGuang_SoC.md) |

---

## 1. 概述

### 1.1 ISP 设计目标

| 指标 | 目标值 | 备注 |
|------|--------|------|
| **摄像头输入** | 16+ 路 | 高清摄像头 |
| **分辨率** | 4K @ 60fps | 单路最大 |
| **总带宽** | 64 GB/s | 16 路 x 4K/30fps |
| **功耗预算** | ≤ 4W | 峰值 |
| **面积预算** | ≤ 4 mm² | 约占 3% |
| **延迟** | < 10 ms | 端到端处理 |
| **安全等级** | ASIL-B | 功能安全 |

### 1.2 ISP 特性

| 特性 | 支持 | 说明 |
|------|------|------|
| **HDR** | 是 | 多帧/单帧 HDR |
| **WDR** | 是 | 宽动态范围 |
| **降噪** | 是 | 2D/3D 降噪 |
| **自动曝光** | 是 | AE 算法 |
| **自动白平衡** | 是 | AWB 算法 |
| **自动对焦** | 是 | AF 统计 |

---

## 2. ISP 架构

### 2.1 系统架构

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           ISP 架构                                       │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    MIPI CSI-2 RX                                │   │
│  │  - 16 lanes (可配置 8/16)                                       │   │
│  │  - D-PHY v1.2 / C-PHY v1.2                                     │   │
│  │  - RAW8/10/12/14/16                                            │   │
│  └────────────────────────────┬────────────────────────────────────┘   │
│                               │                                          │
│                               ▼                                          │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                 ISP Pipeline (可配置顺序)                       │   │
│  │                                                                 │   │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐  │   │
│  │  │ Sensor  │→│  BLC    │→│  DPC    │→│  Lens   │→│  WB     │  │   │
│  │  │ Interface│ │  Black  │ │  Defect │ │ Shading │ │  White  │  │   │
│  │  │         │ │  Level  │ │  Pixel  │ │  Corr.  │ │  Balance│  │   │
│  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘ └─────────┘  │   │
│  │                                                                 │   │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐  │   │
│  │  │  Demosaic│→│  CCM    │→│  Gamma  │→│  Noise  │→│  Sharp  │  │   │
│  │  │         │ │  Color  │ │  Encode │ │  Reduce │ │  ening  │  │   │
│  │  │         │ │  Matrix │ │         │ │         │ │         │  │   │
│  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘ └─────────┘  │   │
│  │                                                                 │   │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐               │   │
│  │  │  HDR    │→│  AE/AWB │→│  Hist   │→│  Output │               │   │
│  │  │  Fusion │ │  Stats  │ │  Stats  │ │  DMA    │               │   │
│  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘               │   │
│  └────────────────────────────┬────────────────────────────────────┘   │
│                               │                                          │
│                               ▼                                          │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    AXI Output Interface                         │   │
│  │  - 输出格式: RGB24, YUV422, YUV420                             │   │
│  │  - 目标: Memory / NPU / Display                                │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 2.2 处理管线配置

| 处理阶段 | 模块 | 处理能力 | 可配置 |
|----------|------|----------|--------|
| **Sensor Interface** | MIPI CSI-2 | 16 lanes x 4.5 Gbps | 是 |
| **Sensor Correction** | BLC/DPC/LSC | 实时处理 | 是 |
| **Color Processing** | Demosaic/CCM/Gamma | 4K/60fps | 是 |
| **Enhancement** | NR/Sharpening | 4K/60fps | 是 |
| **HDR** | HDR Fusion | 4K/60fps (2x) | 是 |
| **Statistics** | AE/AWB/Hist | 4K/30fps | 是 |
| **Output** | Output Formatter | 4K/60fps | 是 |

---

## 3. 输入接口

### 3.1 MIPI CSI-2 配置

| 参数 | 规格 |
|------|------|
| **标准** | MIPI CSI-2 v2.0 |
| **PHY** | D-PHY v1.2 / C-PHY v1.2 |
| **Lane 数** | 8-16 可配置 |
| **速率** | 4.5 Gbps/lane (D-PHY) |
| **总带宽** | 64 GB/s (16 lanes) |
| **RAW 格式** | RAW8/10/12/14/16 |
| **虚拟通道** | 4 虚拟通道 |

### 3.2 像素处理

| 参数 | 规格 |
|------|------|
| **输入位宽** | 8-16 bit RAW |
| **处理位宽** | 20 bit 内部 |
| **输出位宽** | 8-16 bit |
| **动态范围** | 120 dB (HDR) |

---

## 4. 处理模块规格

### 4.1 Black Level Correction (BLC)

| 参数 | 规格 |
|------|------|
| **校正范围** | ±64 LSB |
| **粒度** | 1 LSB |
| **模式** | 固定/自适应 |

### 4.2 Defect Pixel Correction (DPC)

| 参数 | 规格 |
|------|------|
| **检测方法** | 梯度检测 |
| **校正方法** | 邻域插值 |
| **死像素阈值** | 可配置 |
| **处理能力** | 4K/60fps |

### 4.3 Lens Shading Correction (LSC)

| 参数 | 规格 |
|------|------|
| **校正表大小** | 17x17 x 4 channels |
| **插值** | 双线性 |
| **更新频率** | 帧级 |

### 4.4 Demosaic

| 参数 | 规格 |
|------|------|
| **算法** | 高级自适应 |
| **输出** | RGB Bayer → RGB |
| **处理能力** | 4K/60fps |
| **伪影抑制** | 抗锯齿处理 |

### 4.5 Color Correction Matrix (CCM)

| 参数 | 规格 |
|------|------|
| **矩阵** | 3x3 |
| **精度** | 12-bit |
| **模式** | 固定/自适应 |

### 4.6 Gamma Encoding

| 参数 | 规格 |
|------|------|
| **Gamma 曲线** | 2.2 / 可配置 |
| **位数** | 12-bit LUT |
| **分段数** | 256 segments |

### 4.7 Noise Reduction (NR)

| 参数 | 规格 |
|------|------|
| **3D NR** | 时域+空域 |
| **2D NR** | 空域滤波 |
| **强度** | 可配置 |
| **处理能力** | 4K/60fps |

### 4.8 Sharpening

| 参数 | 规格 |
|------|------|
| **算法** | 非锐化掩膜 |
| **强度** | 可配置 |
| **阈值** | 可配置 |
| **处理能力** | 4K/60fps |

### 4.9 HDR Fusion

| 参数 | 规格 |
|------|------|
| **帧数** | 2-4 帧 |
| **曝光比** | 16x 最大 |
| **融合算法** | 权重图融合 |
| **处理能力** | 4K/60fps (2x HDR) |

---

## 5. 统计模块

### 5.1 AE (Auto Exposure) 统计

| 参数 | 规格 |
|------|------|
| **分区** | 16x16 grid |
| **统计** | 亮度直方图 |
| **输出** | Y 通道统计 |
| **更新率** | 每帧 |

### 5.2 AWB (Auto White Balance) 统计

| 参数 | 规格 |
|------|------|
| **分区** | 32x32 grid |
| **统计** | R/G/B 累加 |
| **色温估计** | 支持 |
| **CCM 建议** | 支持 |

### 5.3 Histogram 统计

| 参数 | 规格 |
|------|------|
| **Histogram** | 256 bins x 4 channels |
| **分区** | 可配置 ROI |
| **累积** | 帧/区域累积 |

---

## 6. 输出接口

### 6.1 输出格式

| 格式 | 位宽 | 用途 |
|------|------|------|
| **RAW16** | 16 bit | 原始输出 |
| **RGB24** | 24 bit | Display |
| **RGB30** | 30 bit | High-DR Display |
| **YUV422** | 16 bit | 编码输入 |
| **YUV420** | 12 bit | 编码输入 |

### 6.2 输出目标

| 目标 | 接口 | 带宽 |
|------|------|------|
| **Memory** | AXI4 | 32 GB/s |
| **NPU** | AXI4 | 64 GB/s |
| **Display** | DPI/DCI | 16 GB/s |

---

## 7. 性能分析

### 7.1 处理性能

| 分辨率 | 帧率 | 带宽需求 | 备注 |
|--------|------|----------|------|
| **4K (3840x2160)** | 60 fps | 16 GB/s | 单路 |
| **4K (3840x2160)** | 30 fps | 32 GB/s | 4 路并行 |
| **1080p (1920x1080)** | 120 fps | 8 GB/s | 单路 |
| **720p (1280x720)** | 240 fps | 4 GB/s | 单路 |

### 7.2 延迟分析

| 处理阶段 | 延迟 (lines) |
|----------|--------------|
| **Sensor Interface** | 2 |
| **Pipeline Processing** | 64 |
| **Output Formatter** | 4 |
| **总计** | **~70 lines** |

---

## 8. 功耗分析

### 8.1 功耗预算

| 模块 | 动态功耗 (W) | 静态功耗 (W) | 峰值功耗 (W) |
|------|--------------|--------------|--------------|
| **MIPI RX** | 0.8 | 0.1 | 0.9 |
| **Pipeline** | 1.5 | 0.3 | 1.8 |
| **Statistics** | 0.3 | 0.1 | 0.4 |
| **Output DMA** | 0.4 | 0.1 | 0.5 |
| **时钟树** | 0.3 | 0.1 | 0.4 |
| **总计** | **3.3** | **0.7** | **4.0** |

---

## 9. 面积分析

### 9.1 面积预算

| 模块 | 面积 (mm²) | 占比 |
|------|------------|------|
| **MIPI RX** | 0.8 | 20% |
| **Pipeline (8 stages)** | 2.0 | 50% |
| **Statistics** | 0.6 | 15% |
| **Output DMA** | 0.4 | 10% |
| **时钟复位** | 0.2 | 5% |
| **总计** | **4.0** | **100%** |

---

## 10. 验证计划

### 10.1 验证目标

| 验证类型 | 覆盖率目标 | 工具 |
|----------|------------|------|
| **功能覆盖率** | 100% | UVM |
| **图像质量** | 主观评价 | 图像测试 |
| **性能验证** | 目标达成 | 仿真 |

### 10.2 验证用例

| 用例类别 | 用例数 | 说明 |
|----------|--------|------|
| **功能测试** | 200+ | 管线处理测试 |
| **图像质量测试** | 50+ | 图像质量主观评价 |
| **异常测试** | 100+ | 错误注入测试 |

---

## 11. 交付物和时间表

| 交付物 | 截止日期 | 状态 |
|--------|----------|------|
| ISP 微架构规格 | 2026-02-28 | 进行中 |
| Pipeline 设计 | 2026-04-15 | 未开始 |
| RTL 代码冻结 | 2026-07-31 | 未开始 |
| DV 验证通过 | 2026-10-31 | 未开始 |

---

## 12. 审批

| 角色 | 姓名 | 签名 | 日期 |
|------|------|------|------|
| ISP 架构师 | [待确认] | - | - |
| 首席架构师 | [待确认] | - | - |
| 项目经理 | [待确认] | - | - |

---

**文档版本**: V1.0  
**最后更新**: 2026-01-19  
**状态**: 草稿  
**下一步**: 开始 RTL 代码开发

---
*本规格书作为 ISP 子系统详细设计的指导文件。*