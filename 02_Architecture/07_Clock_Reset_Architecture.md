# 摇光(YaoGuang) SoC 时钟复位架构规格

## 文档信息

| 项目 | 内容 |
|------|------|
| 文档版本 | V1.0 |
| 创建日期 | 2026-01-19 |
| 最后更新 | 2026-01-19 |
| 状态 | 草稿 |
| 负责人 | 时钟架构师 |
| 关联文档 | 架构规格书 (01_Architecture_Spec_YaoGuang_SoC.md) |

---

## 1. 概述

### 1.1 时钟复位设计目标

| 指标 | 目标值 | 备注 |
|------|--------|------|
| **时钟域数量** | ≤ 12 | 简化时钟域跨越 |
| **最高时钟频率** | 2.0 GHz | CPU/NPU 核心 |
| **时钟精度** | ±100 ppm | 晶体精度 |
| **复位域数量** | ≤ 8 | 简化复位域跨越 |
| **上电复位时间** | < 10 ms | POR 释放时间 |
| **功耗预算** | ≤ 1.5W | 时钟复位树 |

### 1.2 设计原则

1. **时钟域分离**: 关键路径与低速外设分离
2. **同步设计**: 避免异步跨时钟域
3. **复位策略**: 统一复位架构，简化复位树
4. **低功耗**: 广泛使用时钟门控

---

## 2. 时钟架构

### 2.1 时钟树结构

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           时钟架构                                       │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│     ┌─────────────────────────────────────────────────────────────┐    │
│     │                    外部时钟源 (24 MHz)                       │    │
│     │                    Crystal Oscillator                       │    │
│     └────────────────────────────┬───────────────────────────────┘    │
│                                  │                                        │
│                                  ▼                                        │
│     ┌─────────────────────────────────────────────────────────────┐    │
│     │                   PLL Cluster 1                             │    │
│     │  - PLL_MAIN: 2.0 GHz (CPU/NPU)                             │    │
│     │  - PLL_PERI: 1.0 GHz (外设)                                │    │
│     └────────────────────────────┬───────────────────────────────┘    │
│                                  │                                        │
│              ┌───────────────────┼───────────────────┐                  │
│              ▼                   ▼                   ▼                  │
│     ┌───────────────┐   ┌───────────────┐   ┌───────────────┐          │
│     │   clk_core    │   │   clk_npu     │   │   clk_sys      │          │
│     │   2.0 GHz     │   │   2.0 GHz     │   │   1.0 GHz      │          │
│     │  (8x A78AE)   │   │  (4x NPU)     │   │  (NoC/外设)    │          │
│     └───────────────┘   └───────────────┘   └───────────────┘          │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 2.2 时钟域定义

| 时钟域 | 频率 | 来源 | 驱动模块 | 用途 |
|--------|------|------|----------|------|
| **clk_core** | 1.5-2.0 GHz | PLL_MAIN | CPU 集群 | 8x Cortex-A78AE |
| **clk_safety** | 1.0-1.5 GHz | PLL_MAIN | 安全处理器 | 2x Cortex-R52 |
| **clk_npu** | 1.5-2.0 GHz | PLL_MAIN | NPU 集群 | 4x NPU Cluster |
| **clk_gpu** | 1.0-1.5 GHz | PLL_MAIN | GPU 集群 | Mali-G78 |
| **clk_isp** | 800 MHz | PLL_MAIN | ISP | 图像处理 |
| **clk_noc** | 2.0 GHz | PLL_MAIN | NoC | 片上互连 |
| **clk_mem** | 1.6 GHz | PLL_DDR | DDR 控制器 | LPDDR5 MC |
| **clk_sys** | 1.0 GHz | PLL_PERI | 系统外设 | APB/AHB |
| **clk_usb** | 480 MHz | PLL_USB | USB 控制器 | USB 3.2 |
| **clk_pcie** | 250 MHz | PLL_PCIE | PCIe 控制器 | PCIe Gen4 |
| **clk_eth** | 312.5 MHz | PLL_ETH | Ethernet | 10G Ethernet |
| **clk_rtc** | 32.768 kHz | RTC 晶体 | RTC | 实时时钟 |

### 2.3 PLL 配置

| PLL | 输入频率 | 输出频率 | 相位噪声 | 用途 |
|-----|----------|----------|----------|------|
| **PLL_MAIN** | 24 MHz | 0.5-2.5 GHz | < -100 dBc/Hz | CPU/NPU/GPU |
| **PLL_DDR** | 24 MHz | 0.4-2.0 GHz | < -110 dBc/Hz | DDR 控制器 |
| **PLL_PERI** | 24 MHz | 0.1-1.0 GHz | < -90 dBc/Hz | 外设 |
| **PLL_USB** | 24 MHz | 480 MHz | < -80 dBc/Hz | USB |
| **PLL_PCIE** | 24 MHz | 100-500 MHz | < -85 dBc/Hz | PCIe |
| **PLL_ETH** | 24 MHz | 312.5 MHz | < -85 dBc/Hz | Ethernet |

---

## 3. 时钟门控

### 3.1 时钟门控架构

```
┌─────────────────────────────────────────────────────────────────┐
│                    时钟门控单元 (CG)                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   ┌───────────────┐                                             │
│   │   Clock       │                                             │
│   │   Enable      │                                             │
│   │   (Register)  │                                             │
│   └───────┬───────┘                                             │
│           │                                                      │
│           ▼                                                      │
│   ┌───────────────┐                                             │
│   │   AND Gate    │                                             │
│   │   (Glitch-free)│                                            │
│   └─────────┬───────┘                                           │
│           │                                                      │
│   ┌───────▼───────┐                                             │
│   │   Clock       │                                             │
│   │   Output      │                                             │
│   └───────────────┘                                             │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 3.2 时钟门控策略

| 模块 | 门控类型 | 节省功耗 | 门控粒度 |
|------|----------|----------|----------|
| **CPU Core** | 自动 CG | 30-40% | 核心级 |
| **NPU Cluster** | 自动 CG | 20-30% | 集群级 |
| **L2 Cache** | 自动 CG | 15-20% | Bank 级 |
| **L3 Cache** | 自动 CG | 10-15% | Bank 级 |
| **NoC** | 自动 CG | 10-15% | 端口级 |
| **外设** | 软件 CG | 30-50% | 模块级 |

### 3.3 门控控制

| 控制方式 | 响应时间 | 用途 |
|----------|----------|------|
| **硬件自动** | < 10 cycles | 空闲检测 |
| **软件控制** | < 100 cycles | 功耗管理 |
| **DVFS 协同** | < 1000 cycles | 频率调整 |

---

## 4. 复位架构

### 4.1 复位树结构

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           复位架构                                       │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│     ┌─────────────────────────────────────────────────────────────┐    │
│     │                    上电复位 (POR)                           │    │
│     │  - 检测电源稳定                                             │    │
│     │  - 延时释放 (configurable)                                 │    │
│     └────────────────────────────┬───────────────────────────────┘    │
│                                  │                                        │
│                                  ▼                                        │
│     ┌─────────────────────────────────────────────────────────────┐    │
│     │                   复位控制器 (RSTM)                          │    │
│     │  - 复位序列生成                                             │    │
│     │  - 复位去抖动                                               │    │
│     │  - 复位监测                                                 │    │
│     └────────────────────────────┬───────────────────────────────┘    │
│                                  │                                        │
│              ┌───────────────────┼───────────────────┐                  │
│              ▼                   ▼                   ▼                  │
│     ┌───────────────┐   ┌───────────────┐   ┌───────────────┐          │
│     │   rst_core_n  │   │   rst_npu_n   │   │   rst_sys_n    │          │
│     │   (同步复位)  │   │   (同步复位)  │   │   (同步复位)  │          │
│     └───────────────┘   └───────────────┘   └───────────────┘          │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 4.2 复位域定义

| 复位域 | 同步/异步 | 释放顺序 | 驱动模块 |
|--------|-----------|----------|----------|
| **rst_por_n** | 异步 | 0 (最先) | POR 电路 |
| **rst_core_n** | 同步 | 1 | CPU 集群 |
| **rst_safety_n** | 同步 | 1 | 安全处理器 |
| **rst_npu_n** | 同步 | 2 | NPU 集群 |
| **rst_gpu_n** | 同步 | 2 | GPU 集群 |
| **rst_noc_n** | 同步 | 2 | NoC |
| **rst_mem_n** | 同步 | 3 | 存储器控制器 |
| **rst_sys_n** | 同步 | 3 | 系统外设 |

### 4.3 复位类型

| 复位类型 | 触发源 | 传播范围 | 用途 |
|----------|--------|----------|------|
| **POR** | 电源监测 | 全芯片 | 上电复位 |
| **warm_reset** | 软件/看门狗 | 全芯片 | 热复位 |
| **core_reset** | 软件/看门狗 | 单核 | CPU 核复位 |
| **debug_reset** | 调试器 | 调试逻辑 | 调试复位 |
| **safety_reset** | 安全监测 | 安全岛 | 安全复位 |

---

## 5. 时钟复位控制器 (CCF)

### 5.1 CCF 功能

| 功能 | 说明 |
|------|------|
| **PLL 控制** | PLL 开关、频率调整 |
| **时钟门控** | 自动/手动时钟门控 |
| **复位管理** | 复位序列、复位去抖 |
| **时钟监测** | 时钟丢失检测 |
| **复位监测** | 看门狗复位 |

### 5.2 时钟监测

| 监测项目 | 检测方法 | 响应 |
|----------|----------|------|
| **时钟丢失** | 时钟监测器 | 切换到安全时钟 |
| **时钟偏差** | 频率比较 | 告警 |
| **时钟抖动** | 相位噪声监测 | 告警 |

### 5.3 复位看门狗

| 参数 | 规格 |
|------|------|
| **超时时间** | 可配置 (1-100 ms) |
| **窗口模式** | 支持 |
| **计数器宽度** | 32-bit |
| **响应** | 系统复位 + 中断 |

---

## 6. 电源域与时钟/复位

### 6.1 电源域定义

| 电源域 | 电压 | 时钟域 | 复位域 | 电源门控 |
|--------|------|--------|--------|----------|
| **PD_CPU** | 0.8-1.0V | clk_core | rst_core_n | 支持 |
| **PD_SAFETY** | 0.8-1.0V | clk_safety | rst_safety_n | 支持 |
| **PD_NPU** | 0.8-1.0V | clk_npu | rst_npu_n | 支持 |
| **PD_GPU** | 0.8-1.0V | clk_gpu | rst_gpu_n | 支持 |
| **PD_NOC** | 0.8-1.0V | clk_noc | rst_noc_n | 支持 |
| **PD_MEM** | 0.8-1.0V | clk_mem | rst_mem_n | 不支持 |
| **PD_SYS** | 0.8-1.0V | clk_sys | rst_sys_n | 支持 |

### 6.2 上电/下电序列

| 阶段 | 时钟 | 复位 | 电源 | 时间 |
|------|------|------|------|------|
| **Phase 0** | OFF | Assert | OFF | - |
| **Phase 1** | OFF | Assert | ON | t_VDD_rise |
| **Phase 2** | OFF | Assert | Stable | t_VDD_stable |
| **Phase 3** | PLL Lock | Assert | Stable | t_PLL_lock |
| **Phase 4** | ON | De-assert | Stable | t_reset_deassert |
| **Phase 5** | ON | De-assert | Stable | Ready |

---

## 7. 功耗分析

### 7.1 时钟功耗

| 模块 | 动态功耗 (W) | 静态功耗 (W) | 峰值功耗 (W) |
|------|--------------|--------------|--------------|
| **PLL** | 0.2 | 0.05 | 0.25 |
| **时钟树 (CPU)** | 0.4 | 0.1 | 0.5 |
| **时钟树 (NPU)** | 0.3 | 0.08 | 0.38 |
| **时钟树 (其他)** | 0.2 | 0.05 | 0.25 |
| **时钟门控逻辑** | 0.05 | 0.02 | 0.07 |
| **时钟监测** | 0.02 | 0.01 | 0.03 |
| **总计** | **1.17** | **0.31** | **1.48** |

### 7.2 复位功耗

| 模块 | 功耗 (W) |
|------|----------|
| **复位树** | 0.1 |
| **复位控制器** | 0.05 |
| **看门狗** | 0.02 |
| **总计** | **0.17** |

---

## 8. 面积分析

### 8.1 面积预算

| 模块 | 面积 (mm²) | 占比 |
|------|------------|------|
| **PLL (6x)** | 0.6 | 30% |
| **时钟门控单元** | 0.4 | 20% |
| **时钟树** | 0.5 | 25% |
| **复位控制器** | 0.2 | 10% |
| **复位树** | 0.2 | 10% |
| **监测电路** | 0.1 | 5% |
| **总计** | **2.0** | **100%** |

---

## 9. 时序约束

### 9.1 时钟规格

| 时钟 | 频率 | 周期 | 抖动 (RMS) | 偏差 |
|------|------|------|------------|------|
| **clk_core** | 2.0 GHz | 500 ps | < 5 ps | < 20 ps |
| **clk_npu** | 2.0 GHz | 500 ps | < 5 ps | < 20 ps |
| **clk_noc** | 2.0 GHz | 500 ps | < 5 ps | < 20 ps |
| **clk_sys** | 1.0 GHz | 1 ns | < 10 ps | < 30 ps |
| **clk_mem** | 1.6 GHz | 625 ps | < 5 ps | < 20 ps |

### 9.2 复位时序

| 参数 | 最小值 | 最大值 |
|------|--------|--------|
| **复位脉冲宽度** | 10 cycles | - |
| **复位释放时间** | 100 cycles | 1000 cycles |
| **复位到时钟启动** | 5 cycles | - |
| **时钟到复位释放** | 5 cycles | - |

---

## 10. 安全机制

### 10.1 安全特性

| 特性 | 实现 | ASIL 等级 |
|------|------|----------|
| **时钟监测** | 时钟丢失检测 | ASIL-D |
| **双 PLL 备份** | 冗余 PLL | ASIL-D |
| **安全复位** | 独立复位域 | ASIL-D |
| **复位看门狗** | 独立看门狗 | ASIL-D |
| **时钟锁相** | PLL 锁定监测 | ASIL-B |

### 10.2 故障处理

| 故障 | 检测方法 | 响应策略 |
|------|----------|----------|
| **PLL 失锁** | 锁定监测 | 切换备份 PLL |
| **时钟丢失** | 时钟监测器 | 安全复位 |
| **复位卡死** | 看门狗 | 强制复位 |
| **复位噪声** | 去抖滤波 | 忽略毛刺 |

---

## 11. 验证计划

### 11.1 验证目标

| 验证类型 | 覆盖率目标 | 工具 |
|----------|------------|------|
| **功能覆盖率** | 100% | UVM |
| **时序验证** | 目标频率 | PrimeTime |
| **功耗验证** | 目标功耗 | PowerArtist |
| **形式验证** | 关键安全逻辑 | JasperGold |

### 11.2 验证用例

| 用例类别 | 用例数 | 说明 |
|----------|--------|------|
| **时钟测试** | 50+ | 频率/相位/抖动测试 |
| **复位测试** | 50+ | 复位序列/去抖测试 |
| **门控测试** | 30+ | 时钟门控测试 |
| **异常测试** | 50+ | 故障注入测试 |

---

## 12. 交付物和时间表

| 交付物 | 截止日期 | 状态 |
|--------|----------|------|
| 时钟复位架构规格 | 2026-02-28 | 未开始 |
| PLL 设计 | 2026-03-31 | 未开始 |
| 时钟树综合 | 2026-05-15 | 未开始 |
| 复位逻辑设计 | 2026-04-30 | 未开始 |
| RTL 代码冻结 | 2026-06-30 | 未开始 |

---

## 13. 审批

| 角色 | 姓名 | 签名 | 日期 |
|------|------|------|------|
| 时钟架构师 | [待确认] | - | - |
| 首席架构师 | [待确认] | - | - |
| 项目经理 | [待确认] | - | - |

---

**文档版本**: V1.0  
**最后更新**: 2026-01-19  
**状态**: 草稿  
**下一步**: 开始 RTL 代码开发

---
*本规格书作为时钟复位架构详细设计的指导文件。*